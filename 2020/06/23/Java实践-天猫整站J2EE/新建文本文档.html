<h1 id="九、业务类"><a class="header-anchor" href="#九、业务类">¶</a>九、业务类</h1>
<h2 id="1、SERVICE"><a class="header-anchor" href="#1、SERVICE">¶</a>1、SERVICE</h2>
<p>业务类Service</p>
<h3 id="步骤-1-通常的设计流程"><a class="header-anchor" href="#步骤-1-通常的设计流程">¶</a>步骤 1 : 通常的设计流程</h3>
<p>作为J2EE web 应用，一般会按照如图所示的设计流程进行<br>
Servlet -&gt; Service（业务类） -&gt; DAO -&gt; database</p>
<p>当浏览器提交请求到tomcat web 服务器的时候，对应的servlet的doGet/doPost方法会被调用，接着在servlet中调用Service类，然后在Service类中调用DAO类，最后在DAO中访问数据库获取相应的数据。</p>
<p><img src="3731.png" alt=""></p>
<h3 id="步骤-2-不使用Service及其原因"><a class="header-anchor" href="#步骤-2-不使用Service及其原因">¶</a>步骤 2 : 不使用Service及其原因</h3>
<p>在本模仿天猫整站-J2ee 版本中，不使用Service这一层。 原因是在DAO进行了比较详细的设计，已经提供了很好的支持业务的方法。</p>
<p>如果在DAO上包裹一层Service业务类，不过是在直接调用DAO设计好的方法罢了，反而显得画蛇添足，增加学习的累赘。</p>
<p>所以在本项目做，取消了Service业务类这一层。 但是大家要知道有这么一个概念，以后进了公司，接触前辈留下来的项目的时候，要看得懂有这么一层业务类Service的存在。</p>
<h1 id="十、原型-后端"><a class="header-anchor" href="#十、原型-后端">¶</a>十、原型-后端</h1>
<h2 id="1、概述"><a class="header-anchor" href="#1、概述">¶</a>1、概述</h2>
<p>接下来是后端的原型界面。 并不是所有的后端，都需要原型，特别是比较典型的[CRUD]维护管理页面，开发人员基于现存的模板做起来也是比较快的。</p>
<p>不过本项目里的后端又不仅仅是CRUD维护管理页面，还有一些其他略复杂的功能，所以还是把这些原型界面都做出来。 后续开发功能的时候，就可以基于这些原型界面进行。</p>
<h2 id="2、分类管理"><a class="header-anchor" href="#2、分类管理">¶</a>2、分类管理</h2>
<h3 id="步骤-1-效果"><a class="header-anchor" href="#步骤-1-效果">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="3、属性管理"><a class="header-anchor" href="#3、属性管理">¶</a>3、属性管理</h2>
<h3 id="步骤-1-效果-v2"><a class="header-anchor" href="#步骤-1-效果-v2">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="4、产品管理"><a class="header-anchor" href="#4、产品管理">¶</a>4、产品管理</h2>
<h3 id="步骤-1-效果-v3"><a class="header-anchor" href="#步骤-1-效果-v3">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="5、产品图片管理"><a class="header-anchor" href="#5、产品图片管理">¶</a>5、产品图片管理</h2>
<h3 id="步骤-1-效果-v4"><a class="header-anchor" href="#步骤-1-效果-v4">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="6、产品属性设置"><a class="header-anchor" href="#6、产品属性设置">¶</a>6、产品属性设置</h2>
<h3 id="步骤-1-效果-v5"><a class="header-anchor" href="#步骤-1-效果-v5">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="7、用户管理"><a class="header-anchor" href="#7、用户管理">¶</a>7、用户管理</h2>
<h3 id="步骤-1-效果-v6"><a class="header-anchor" href="#步骤-1-效果-v6">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h2 id="8、订单管理"><a class="header-anchor" href="#8、订单管理">¶</a>8、订单管理</h2>
<h3 id="步骤-1-效果-v7"><a class="header-anchor" href="#步骤-1-效果-v7">¶</a>步骤 1 : 效果</h3>
<p>**注：**这里的原型是展示效果，让大家有个感性的认识，编码不在这里进行，项目开发过程会在后面的章节从零开始。</p>
<h1 id="十一、后台-分类管理"><a class="header-anchor" href="#十一、后台-分类管理">¶</a>十一、后台-分类管理</h1>
<h2 id="1、概述-v2"><a class="header-anchor" href="#1、概述-v2">¶</a>1、概述</h2>
<p>到这里就开始讲解功能开发了。 开发整站的顺序，通常来说还是按照依赖性来进行，前端需要的数据，都要先通过后台的功能维护在数据库中，才可以拿到。<br>
所以，先进行后台功能的开发，然后再是前台功能的开发。</p>
<p>后台在系统设计的时候，并不是简单的每个功能对应一个Servlet，而是使用了反射的技术，结合过滤器Filter进行了封装，使得开发配置以及维护成本降低了很多。 所以在讲解第一个后台功能-分类管理的时候，就会花相当的篇幅来解构后台的功能是如何设计的。</p>
<p>为了便于大家理解和消化这部分知识，采用如下节奏进行</p>
<ol>
<li>首先下载一个只有分类管理的可运行项目，先跑起来看看效果</li>
<li>理解BackServletFilter+BaseBackServlet这种设计模式</li>
<li>再以查询为例子，运用这种设计模式，并且分析其带来的好处</li>
<li>分页功能单独拿出来讲解</li>
<li>最后讲解分类管理中其他的，增加，删除，编辑和修改功能</li>
</ol>
<h2 id="2、可运行的项目"><a class="header-anchor" href="#2、可运行的项目">¶</a>2、可运行的项目</h2>
<h3 id="步骤-1-可运行项目"><a class="header-anchor" href="#步骤-1-可运行项目">¶</a>步骤 1 : 可运行项目</h3>
<p>下载右侧的tmall.rar，并解压到<strong>e:/project/tmall</strong><br>
<strong>注：</strong> 必须是e:/project/tmall,因为项目配置文件里的jar包等配置，都是依赖这个路径<br>
<strong>注：</strong> 后续每个有新功能追加的知识点，都有一个可运行项目下载，并且都是指向 <strong>e:/project/tmall</strong>, 为了后续学习的顺畅，请务必使用这个目录</p>
<h3 id="步骤-2-在tomcat中配置tmall"><a class="header-anchor" href="#步骤-2-在tomcat中配置tmall">¶</a>步骤 2 : 在tomcat中配置tmall</h3>
<p>打开tomcat/conf/server.xml，在&lt;Host下增加一个&lt;context</p>
<pre><code class="language-java">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
	&lt;Context path=&quot;/tmall&quot; docBase=&quot;E:\\project\\tmall\\web&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; /&gt;
</code></pre>
<p>通过这种方式部署tmall web应用，注意reloadable=“false” 要设置为false，不要自动重载，这个功能tomcat本身做的不够完善，会带来意想不到的问题。</p>
<p>为什么不用Eclipse EE版本,或者MyEclipse的自带的tomcat 启动？<br>
因为大家工作以后，最常见的工作环境是： 在Windows下开发，然后把开发好的web项目部署到Linux的服务器上。 是不可能在Linux启动一个eclipse/myeclipse，然后里面跑一个tomcat来运行的！<br>
所以尽可能采用接近生产环境的方式部署web应用，也是为了让以后能够工作的更加平滑。</p>
<p>如果这一步老是配置不成功，可以使用下面的server.xml完整文件代码，或者右边下载server.xml来替换。</p>
<p><strong>注：</strong> 这个完整的server.xml里用的端口号是<strong>8080</strong><br>
<strong>注：</strong> 不要忘记建立数据库和表结构[tmall.sql]</p>
<pre><code class="language-xml">&lt;?xml version='1.0' encoding='utf-8'?&gt;
&lt;Server port=&quot;8085&quot; shutdown=&quot;SHUTDOWN&quot;&gt;
  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.JasperListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;
  &lt;GlobalNamingResources&gt;
    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;
              type=&quot;org.apache.catalina.UserDatabase&quot;
              description=&quot;User database that can be updated and saved&quot;
              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;
              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;
  &lt;/GlobalNamingResources&gt;
  &lt;Service name=&quot;Catalina&quot;&gt;
    &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;
               connectionTimeout=&quot;20000&quot;
               redirectPort=&quot;8443&quot; /&gt;
    &lt;Connector port=&quot;8089&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;
    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;
      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;
        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;
               resourceName=&quot;UserDatabase&quot;/&gt;
      &lt;/Realm&gt;
      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
					&lt;Context path=&quot;/tmall&quot; docBase=&quot;E:\\project\\tmall\\web&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; /&gt;
		
       &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;
               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;
               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;
      &lt;/Host&gt;
    &lt;/Engine&gt;
  &lt;/Service&gt;
&lt;/Server&gt;
</code></pre>
<h3 id="步骤-3-启动Tomcat并观察效果"><a class="header-anchor" href="#步骤-3-启动Tomcat并观察效果">¶</a>步骤 3 : 启动Tomcat并观察效果</h3>
<p>运行tomcat下的startup.bat并访问地址：</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin
</code></pre>
<p>观察运行效果</p>
<p><strong>注意：</strong> 这里会看到在前面测试CategoryDAO的时候，创建的一些分类对象。而这些数据，是没有图片信息的，因为当时测试[CategoryDAO]，还没有开发上传图片功能。</p>
<h3 id="步骤-4-tomcat-启动失败"><a class="header-anchor" href="#步骤-4-tomcat-启动失败">¶</a>步骤 4 : tomcat 启动失败</h3>
<p>如果tomcat启动失败，通常是因为8080端口被占用了，有可能是Oracle占用了8080端口，关闭掉Oracle即可。</p>
<p>如果不是Oracle占用，按照如下办法排查，并关闭对应程序： [Tomcat端口被占用怎么办]</p>
<h2 id="3、静态资源"><a class="header-anchor" href="#3、静态资源">¶</a>3、静态资源</h2>
<p>接下来，解析这个可运行项目。<br>
首先从最简单的静态资源开始</p>
<h3 id="步骤-1-图片资源"><a class="header-anchor" href="#步骤-1-图片资源">¶</a>步骤 1 : 图片资源</h3>
<p>在img目录下的site目录放着所有要用到的静态图片，如猫耳朵什么的</p>
<p><img src="3749.png" alt=""></p>
<h3 id="步骤-2-css"><a class="header-anchor" href="#步骤-2-css">¶</a>步骤 2 : css</h3>
<p>在css目录里有3个子目录</p>
<ol>
<li>
<p>back<br>
这个目录里有一个style.css,这是后台界面用到的样式</p>
</li>
<li>
<p>bootstrap<br>
这里存放的是bootstrap的css样式文件</p>
</li>
<li>
<p>fore<br>
这个目录里<strong>也</strong>有一个style.css,这是前台界面用到的样式</p>
</li>
</ol>
<p><img src="3750.png" alt=""></p>
<h3 id="步骤-3-js"><a class="header-anchor" href="#步骤-3-js">¶</a>步骤 3 : js</h3>
<p>js目录下有两个子目录<br>
/bootstrap<br>
bootstrap用到的js文件<br>
/jquery<br>
jquery用到的js文件</p>
<p><img src="3751.png" alt=""></p>
<h3 id="步骤-4-jars"><a class="header-anchor" href="#步骤-4-jars">¶</a>步骤 4 : jars</h3>
<p>除了图片资源外，还用到了各种第三方的jar包</p>
<h2 id="4、FILTER配合SERVLET"><a class="header-anchor" href="#4、FILTER配合SERVLET">¶</a>4、FILTER配合SERVLET</h2>
<h3 id="步骤-1-一个路径对应一个Servlet的弊端"><a class="header-anchor" href="#步骤-1-一个路径对应一个Servlet的弊端">¶</a>步骤 1 : 一个路径对应一个Servlet的弊端</h3>
<p>通过观察</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin_category_list
</code></pre>
<p>可以发现，分类管理需要：增加，删除，编辑，修改，查询5个服务端功能。<br>
那么按照传统的[在web.xml中配置Servlet的方式]，一个路径对应一个Servlet的思路，就需要设计5个Servlet类，并且在web.xml中配置5个路径</p>
<pre><code class="language-xml">AddCategoryServlet
DeleteCategoryServlet
EditCategoryServlet
UpdateCategoryServlet
ListCategoryServlet
</code></pre>
<p>而后台需要做分类，产品，属性，产品图片，用户，订单这么6种管理，那么就一共需要30个Servlet，以及在web.xml中对应的配置，那么配置文件就会变得臃肿，并且容易出错</p>
<p><img src="3738.png" alt=""></p>
<h3 id="步骤-2-对设计进行改进"><a class="header-anchor" href="#步骤-2-对设计进行改进">¶</a>步骤 2 : 对设计进行改进</h3>
<p>但是观察已经实现了分类管理的[可运行项目下载包]里的代码，却发现Servlet只有一个即CategoryServlet，web.xml里，也只有一个CategoryServlet的映射，并没有5个映射。</p>
<p>如图是对于最后完工了的项目的servlet包里类的截图，可以发现，每种实体类，对应了一个Servlet，而不是对应了5个，这样首先从Servlet数量上来讲，就大大的减少了</p>
<p><img src="3739.png" alt=""></p>
<h3 id="步骤-3-原理流程图"><a class="header-anchor" href="#步骤-3-原理流程图">¶</a>步骤 3 : 原理流程图</h3>
<p>那么是如何做到一个CategoryServlet类，就能完成本来需要5个Servlet类才能完成的功能的呢？</p>
<p>让我们借助流程图来分析，为什么访问admin_category_list的时候，CategoryServlet的list()方法会被调用</p>
<p>1.假设访问路径是 <a href="http://127.0.0.1:8080/tmall/admin_category_list" target="_blank" rel="noopener">http://127.0.0.1:8080/tmall/admin_category_list</a><br>
2. 过滤器BackServletFilter进行拦截，判断访问的地址是否以/admin_开头<br>
3. 如果是，那么做如下操作<br>
3.1 取出两个下划线之间的值 category<br>
3.2 取出最后一个下划线之后的值 list<br>
3.3 然后根据这个值，服务端跳转到categoryServlet，并且把list这个值传递过去<br>
4. categoryServlet 继承了BaseBackServlet，其service方法会被调用。 在service中，借助反射技术，根据传递过来的值 list，调用对应categoryServlet 中的方法list()<br>
5. 这样就实现了当访问的路径是 admin_category_list的时候，就会调用categoryServlet.list()方法这样一个效果</p>
<p>换句话说:<br>
如果访问的路径是admin_category_add，就会调用categoryServlet.add()方法<br>
如果访问的路径是admin_category_delete，就会调用categoryServlet.delete()方法<br>
如果访问的路径是admin_category_edit，就会调用categoryServlet.edit()方法<br>
如果访问的路径是admin_category_update，就会调用categoryServlet.update()方法<br>
如此这般，一个categoryServlet类，就完成了本来需要5个Servlet类才能完成的功能。</p>
<p><img src="3741.png" alt=""></p>
<h3 id="步骤-4-代码讲解-BackServletFilter"><a class="header-anchor" href="#步骤-4-代码讲解-BackServletFilter">¶</a>步骤 4 : 代码讲解 - BackServletFilter</h3>
<p>那么BackServletFilter类到底是如何工作的呢？ 接下来我们此类进行代码讲解。</p>
<ol>
<li>首先在web.xml配置文件中，让所有的请求都会经过BackServletFilter</li>
</ol>
<pre><code class="language-xml">&lt;url-pattern&gt;/*&lt;/url-pattern&gt;
</code></pre>
<ol start="2">
<li>还是假设访问的路径是：</li>
</ol>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin_category_list
</code></pre>
<ol start="3">
<li>在BackServletFilter 中通过request.getRequestURI()取出访问的uri: /tmall/admin_category_list</li>
<li>然后截掉/tmall，得到路径/admin_category_list</li>
<li>判断其是否以/admin开头</li>
<li>如果是，那么就取出两个_之间的字符串，category，并且拼接成/categoryServlet，通过服务端跳转到/categoryServlet</li>
<li>在跳转之前，还取出了list字符串，然后通过request.setAttribute的方式，借助服务端跳转，传递到categoryServlet里去</li>
</ol>
<pre><code class="language-java">package tmall.filter;
 
import java.io.IOException;
 
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.StringUtils;
 
public class BackServletFilter implements Filter {
 
    public void destroy() {
         
    }
 
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;
         
        String contextPath=request.getServletContext().getContextPath();
        String uri = request.getRequestURI();
        uri =StringUtils.remove(uri, contextPath);
        if(uri.startsWith(&quot;/admin_&quot;)){     
            String servletPath = StringUtils.substringBetween(uri,&quot;_&quot;, &quot;_&quot;) + &quot;Servlet&quot;;
            String method = StringUtils.substringAfterLast(uri,&quot;_&quot; );
            request.setAttribute(&quot;method&quot;, method);
            req.getRequestDispatcher(&quot;/&quot; + servletPath).forward(request, response);
            return;
        }
         
        chain.doFilter(request, response);
    }
 
    public void init(FilterConfig arg0) throws ServletException {
     
    }
}
</code></pre>
<pre><code class="language-xml">&lt;filter&gt;
    &lt;filter-name&gt;BackServletFilter&lt;/filter-name&gt;
    &lt;filter-class&gt;tmall.filter.BackServletFilter&lt;/filter-class&gt;
&lt;/filter&gt;
 
&lt;filter-mapping&gt;
    &lt;filter-name&gt;BackServletFilter&lt;/filter-name&gt;
    &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
&lt;/filter-mapping&gt;
</code></pre>
<h3 id="步骤-5-代码讲解-CategoryServlet和BaseBackServlet"><a class="header-anchor" href="#步骤-5-代码讲解-CategoryServlet和BaseBackServlet">¶</a>步骤 5 : 代码讲解 - CategoryServlet和BaseBackServlet</h3>
<p>接着流程就到了categoryServlet这里。</p>
<p>根据web.xml中的配置</p>
<pre><code class="language-xml">&lt;servlet-name&gt;CategoryServlet&lt;/servlet-name&gt;
&lt;url-pattern&gt;/categoryServlet&lt;/url-pattern&gt;
</code></pre>
<p>服务端跳转/categoryServlet就到了CategoryServlet这个类里</p>
<ol>
<li>
<p>首先CategoryServlet继承了BaseBackServlet，而BaseBackServlet又继承了HttpServlet</p>
</li>
<li>
<p>服务端跳转过来之后，会访问CategoryServlet的doGet()或者doPost()方法</p>
</li>
<li>
<p>在访问doGet()或者doPost()之前，会访问service()方法</p>
</li>
<li>
<p>BaseBackServlet中重写了service() 方法，所以流程就进入到了service()中</p>
</li>
<li>
<p>在service()方法中有三块内容<br>
5.1 第一块是获取分页信息<br>
5.2 第二块是根据[反射]访问对应的方法<br>
5.3 第三块是根据对应方法的返回值，进行服务端跳转、客户端跳转、或者直接输出字符串。</p>
</li>
<li>
<p>第一块和第三块放在后面讲解，这里着重讲解第二块是根据反射访问对应的方法<br>
6.1 取到从BackServletFilter中request.setAttribute()传递过来的值 list<br>
6.2 根据这个值list，借助[反射机制]调用CategoryServlet类中的list()方法<br>
这样就达到了CategoryServlet.list()方法被调用的效果</p>
</li>
</ol>
<pre><code class="language-java">package tmall.servlet;
 
import java.awt.image.BufferedImage;   
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
 
import javax.imageio.ImageIO;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import tmall.bean.Category;
import tmall.util.ImageUtil;
import tmall.util.Page;
 
public class CategoryServlet extends BaseBackServlet {
     
    public String add(HttpServletRequest request, HttpServletResponse response, Page page) {
        Map&lt;String,String&gt; params = new HashMap&lt;&gt;();
        InputStream is = super.parseUpload(request, params);
         
        String name= params.get(&quot;name&quot;);
        Category c = new Category();
        c.setName(name);
        categoryDAO.add(c);
         
        File  imageFolder= new File(request.getSession().getServletContext().getRealPath(&quot;img/category&quot;));
        File file = new File(imageFolder,c.getId()+&quot;.jpg&quot;);
         
        try {
            if(null!=is &amp;&amp; 0!=is.available()){
                try(FileOutputStream fos = new FileOutputStream(file)){
                    byte b[] = new byte[1024 * 1024];
                    int length = 0;
                    while (-1 != (length = is.read(b))) {
                        fos.write(b, 0, length);
                    }
                    fos.flush();
                    //通过如下代码，把文件保存为jpg格式
                    BufferedImage img = ImageUtil.change2jpg(file);
                    ImageIO.write(img, &quot;jpg&quot;, file);       
                }
                catch(Exception e){
                    e.printStackTrace();
                }
            }
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }  
        return &quot;@admin_category_list&quot;;
    }
 
    public String delete(HttpServletRequest request, HttpServletResponse response, Page page) {
        int id = Integer.parseInt(request.getParameter(&quot;id&quot;));
        categoryDAO.delete(id);
        return &quot;@admin_category_list&quot;;
    }
 
    public String edit(HttpServletRequest request, HttpServletResponse response, Page page) {
        int id = Integer.parseInt(request.getParameter(&quot;id&quot;));
        Category c = categoryDAO.get(id);
        request.setAttribute(&quot;c&quot;, c);
        return &quot;admin/editCategory.jsp&quot;;       
    }
 
    public String update(HttpServletRequest request, HttpServletResponse response, Page page) {
        Map&lt;String,String&gt; params = new HashMap&lt;&gt;();
        InputStream is = super.parseUpload(request, params);
         
        System.out.println(params);
        String name= params.get(&quot;name&quot;);
        int id = Integer.parseInt(params.get(&quot;id&quot;));
 
        Category c = new Category();
        c.setId(id);
        c.setName(name);
        categoryDAO.update(c);
         
        File  imageFolder= new File(request.getSession().getServletContext().getRealPath(&quot;img/category&quot;));
        File file = new File(imageFolder,c.getId()+&quot;.jpg&quot;);
        file.getParentFile().mkdirs();
         
        try {
            if(null!=is &amp;&amp; 0!=is.available()){
                try(FileOutputStream fos = new FileOutputStream(file)){
                    byte b[] = new byte[1024 * 1024];
                    int length = 0;
                    while (-1 != (length = is.read(b))) {
                        fos.write(b, 0, length);
                    }
                    fos.flush();
                    //通过如下代码，把文件保存为jpg格式
                    BufferedImage img = ImageUtil.change2jpg(file);
                    ImageIO.write(img, &quot;jpg&quot;, file);       
                }
                catch(Exception e){
                    e.printStackTrace();
                }
            }
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        return &quot;@admin_category_list&quot;;
 
    }
 
    public String list(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs = categoryDAO.list(page.getStart(),page.getCount());
        int total = categoryDAO.getTotal();
        page.setTotal(total);
         
        request.setAttribute(&quot;thecs&quot;, cs);
        request.setAttribute(&quot;page&quot;, page);
         
        return &quot;admin/listCategory.jsp&quot;;
    }
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.InputStream;
 
import java.lang.reflect.Method;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
 
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
 
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.OrderItemDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.dao.PropertyDAO;
import tmall.dao.PropertyValueDAO;
import tmall.dao.ReviewDAO;
import tmall.dao.UserDAO;
import tmall.util.Page;
 
public abstract class BaseBackServlet extends HttpServlet {
 
    public abstract String add(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String delete(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String edit(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String update(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String list(HttpServletRequest request, HttpServletResponse response, Page page) ;
     
    protected CategoryDAO categoryDAO = new CategoryDAO();
    protected OrderDAO orderDAO = new OrderDAO();
    protected OrderItemDAO orderItemDAO = new OrderItemDAO();
    protected ProductDAO productDAO = new ProductDAO();
    protected ProductImageDAO productImageDAO = new ProductImageDAO();
    protected PropertyDAO propertyDAO = new PropertyDAO();
    protected PropertyValueDAO propertyValueDAO = new PropertyValueDAO();
    protected ReviewDAO reviewDAO = new ReviewDAO();
    protected UserDAO userDAO = new UserDAO();
 
    public void service(HttpServletRequest request, HttpServletResponse response) {
        try {
             
            /*获取分页信息*/
            int start= 0;
            int count = 5;
            try {
                start = Integer.parseInt(request.getParameter(&quot;page.start&quot;));
            } catch (Exception e) {
                 
            }
            try {
                count = Integer.parseInt(request.getParameter(&quot;page.count&quot;));
            } catch (Exception e) {
            }
            Page page = new Page(start,count);
             
            /*借助反射，调用对应的方法*/
            String method = (String) request.getAttribute(&quot;method&quot;);
            Method m = this.getClass().getMethod(method, javax.servlet.http.HttpServletRequest.class,
                    javax.servlet.http.HttpServletResponse.class,Page.class);
            String redirect = m.invoke(this,request, response,page).toString();
             
            /*根据方法的返回值，进行相应的客户端跳转，服务端跳转，或者仅仅是输出字符串*/
             
            if(redirect.startsWith(&quot;@&quot;))
                response.sendRedirect(redirect.substring(1));
            else if(redirect.startsWith(&quot;%&quot;))
                response.getWriter().print(redirect.substring(1));
            else
                request.getRequestDispatcher(redirect).forward(request, response);
             
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }
    public InputStream parseUpload(HttpServletRequest request, Map&lt;String, String&gt; params) {
            InputStream is =null;
            try {
                DiskFileItemFactory factory = new DiskFileItemFactory();
                ServletFileUpload upload = new ServletFileUpload(factory);
                // 设置上传文件的大小限制为10M
                factory.setSizeThreshold(1024 * 10240);
                  
                List items = upload.parseRequest(request);
                Iterator iter = items.iterator();
                while (iter.hasNext()) {
                    FileItem item = (FileItem) iter.next();
                    if (!item.isFormField()) {
                        // item.getInputStream() 获取上传文件的输入流
                        is = item.getInputStream();
                    } else {
                        String paramName = item.getFieldName();
                        String paramValue = item.getString();
                        paramValue = new String(paramValue.getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);
                        params.put(paramName, paramValue);
                    }
                }
                  
            } catch (Exception e) {
                e.printStackTrace();
            }
            return is;
        }
}
</code></pre>
<pre><code class="language-xml">&lt;servlet&gt;
    &lt;servlet-name&gt;CategoryServlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;tmall.servlet.CategoryServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
 
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;CategoryServlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/categoryServlet&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;
</code></pre>
<h3 id="步骤-6-一个Servlet类就能满足CRUD一系列业务要求"><a class="header-anchor" href="#步骤-6-一个Servlet类就能满足CRUD一系列业务要求">¶</a>步骤 6 : 一个Servlet类就能满足CRUD一系列业务要求</h3>
<p>通过这样一种模式，一个Servlet类就能满足CRUD一系列业务要求<br>
如果访问的路径是admin_category_list，就会调用categoryServlet.list()方法<br>
如果访问的路径是admin_category_add，就会调用categoryServlet.add()方法<br>
如果访问的路径是admin_category_delete，就会调用categoryServlet.delete()方法<br>
如果访问的路径是admin_category_edit，就会调用categoryServlet.edit()方法<br>
如果访问的路径是admin_category_update，就会调用categoryServlet.update()方法</p>
<p><img src="3744.png" alt=""></p>
<h2 id="5、JSP包含关系"><a class="header-anchor" href="#5、JSP包含关系">¶</a>5、JSP包含关系</h2>
<h3 id="步骤-1-分类查询对应的JSP文件"><a class="header-anchor" href="#步骤-1-分类查询对应的JSP文件">¶</a>步骤 1 : 分类查询对应的JSP文件</h3>
<p>分类查询对应的JSP文件是listCategory.jsp，但是本知识点不讲解listCategory.jsp本身，而是讲解其所包含的几个公共的jsp文件。<br>
listCategory.jsp本身留在[分类管理-查询]，结合[MVC]模式讲解。</p>
<p>listCategory.jsp 用到了4个公共包含文件</p>
<ol>
<li>&lt;%@include file=&quot;…/include/admin/adminHeader.jsp&quot;%&gt;</li>
<li>&lt;%@include file=&quot;…/include/admin/adminNavigator.jsp&quot;%&gt;</li>
<li>&lt;%@include file=&quot;…/include/admin/adminPage.jsp&quot;%&gt;</li>
<li>&lt;%@include file=&quot;…/include/admin/adminFooter.jsp&quot;%&gt;</li>
</ol>
<p><img src="3743.png" alt=""></p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; import=&quot;java.util.*&quot;%&gt;
  
&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;
&lt;%@include file=&quot;../include/admin/adminHeader.jsp&quot;%&gt;
&lt;%@include file=&quot;../include/admin/adminNavigator.jsp&quot;%&gt;
 
&lt;script&gt;
$(function(){
     
    $(&quot;#addForm&quot;).submit(function(){
        if(!checkEmpty(&quot;name&quot;,&quot;分类名称&quot;))
            return false;
        if(!checkEmpty(&quot;categoryPic&quot;,&quot;分类图片&quot;))
            return false;
        return true;
    });
});
 
&lt;/script&gt;
 
&lt;title&gt;分类管理&lt;/title&gt;
 
&lt;div class=&quot;workingArea&quot;&gt;
    &lt;h1 class=&quot;label label-info&quot; &gt;分类管理&lt;/h1&gt;
    &lt;br&gt;
    &lt;br&gt;
     
    &lt;div class=&quot;listDataTableDiv&quot;&gt;
        &lt;table class=&quot;table table-striped table-bordered table-hover  table-condensed&quot;&gt;
            &lt;thead&gt;
                &lt;tr class=&quot;success&quot;&gt;
                    &lt;th&gt;ID&lt;/th&gt;
                    &lt;th&gt;图片&lt;/th&gt;
                    &lt;th&gt;分类名称&lt;/th&gt;
&lt;!--                     &lt;th&gt;属性管理&lt;/th&gt; --&gt;
&lt;!--                     &lt;th&gt;产品管理&lt;/th&gt; --&gt;
                    &lt;th&gt;编辑&lt;/th&gt;
                    &lt;th&gt;删除&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                &lt;c:forEach items=&quot;${thecs}&quot; var=&quot;c&quot;&gt;
                 
                &lt;tr&gt;
                    &lt;td&gt;${c.id}&lt;/td&gt;
                    &lt;td&gt;&lt;img height=&quot;40px&quot; src=&quot;img/category/${c.id}.jpg&quot;&gt;&lt;/td&gt;
                    &lt;td&gt;${c.name}&lt;/td&gt;
                         
&lt;%--                     &lt;td&gt;&lt;a href=&quot;admin_property_list?cid=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-th-list&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;                     --%&gt;
&lt;%--                     &lt;td&gt;&lt;a href=&quot;admin_product_list?cid=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-shopping-cart&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;                    --%&gt;
                    &lt;td&gt;&lt;a href=&quot;admin_category_edit?id=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a deleteLink=&quot;true&quot; href=&quot;admin_category_delete?id=${c.id}&quot;&gt;&lt;span class=&quot;   glyphicon glyphicon-trash&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
     
                &lt;/tr&gt;
                &lt;/c:forEach&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
     
    &lt;div class=&quot;pageDiv&quot;&gt;
        &lt;%@include file=&quot;../include/admin/adminPage.jsp&quot; %&gt;
    &lt;/div&gt;
     
    &lt;div class=&quot;panel panel-warning addDiv&quot;&gt;
      &lt;div class=&quot;panel-heading&quot;&gt;新增分类&lt;/div&gt;
      &lt;div class=&quot;panel-body&quot;&gt;
            &lt;form method=&quot;post&quot; id=&quot;addForm&quot; action=&quot;admin_category_add&quot; enctype=&quot;multipart/form-data&quot;&gt;
                &lt;table class=&quot;addTable&quot;&gt;
                    &lt;tr&gt;
                        &lt;td&gt;分类名称&lt;/td&gt;
                        &lt;td&gt;&lt;input  id=&quot;name&quot; name=&quot;name&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td&gt;分类圖片&lt;/td&gt;
                        &lt;td&gt;
                            &lt;input id=&quot;categoryPic&quot; accept=&quot;image/*&quot; type=&quot;file&quot; name=&quot;filepath&quot; /&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr class=&quot;submitTR&quot;&gt;
                        &lt;td colspan=&quot;2&quot; align=&quot;center&quot;&gt;
                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;提 交&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/form&gt;
      &lt;/div&gt;
    &lt;/div&gt;
     
&lt;/div&gt;
 
&lt;%@include file=&quot;../include/admin/adminFooter.jsp&quot;%&gt;
</code></pre>
<h3 id="步骤-2-adminHeader-jsp"><a class="header-anchor" href="#步骤-2-adminHeader-jsp">¶</a>步骤 2 : adminHeader.jsp</h3>
<p>每个后台页面都在一开始使用了adminHeader.jsp</p>
<ol>
<li>表示本页面会使用html5的技术</li>
</ol>
<pre><code class="language-xml">&lt;!DOCTYPE html&gt;
</code></pre>
<ol start="2">
<li>jsp指令</li>
</ol>
<pre><code class="language-xml">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
	pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
</code></pre>
<p>contentType=“text/html; charset=UTF-8” 告诉浏览器使用UTF-8进行中文编码识别<br>
pageEncoding=“UTF-8” 本jsp上的中文文字，使用UTF-8进行编码<br>
isELIgnored=“false” 本jsp上会使用EL表达式</p>
<ol start="3">
<li>引入JSTL</li>
</ol>
<pre><code class="language-xml">&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;
&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; prefix='fmt' %&gt; 
</code></pre>
<p>使用c和fmt两种标准标签库</p>
<ol start="4">
<li>引入js和css</li>
</ol>
<pre><code class="language-xml">&lt;script src=&quot;js/jquery/2.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;
&lt;link href=&quot;css/bootstrap/3.3.6/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
&lt;script src=&quot;js/bootstrap/3.3.6/bootstrap.min.js&quot;&gt;&lt;/script&gt;
&lt;link href=&quot;css/back/style.css&quot; rel=&quot;stylesheet&quot;&gt;
</code></pre>
<ol start="5">
<li>预先定义一些判断输入框的函数，方便后面使用</li>
</ol>
<pre><code class="language-java">&lt;script&gt;
function checkEmpty(id, name){
	var value = $(&quot;#&quot;+id).val();
	if(value.length==0){
		alert(name+ &quot;不能为空&quot;);
		$(&quot;#&quot;+id)[0].focus();
		return false;
	}
	return true;
}
function checkNumber(id, name){
	var value = $(&quot;#&quot;+id).val();
	if(value.length==0){
		alert(name+ &quot;不能为空&quot;);
		$(&quot;#&quot;+id)[0].focus();
		return false;
	}
	if(isNaN(value)){
		alert(name+ &quot;必须是数字&quot;);
		$(&quot;#&quot;+id)[0].focus();
		return false;
	}
	
	return true;
}
function checkInt(id, name){
	var value = $(&quot;#&quot;+id).val();
	if(value.length==0){
		alert(name+ &quot;不能为空&quot;);
		$(&quot;#&quot;+id)[0].focus();
		return false;
	}
	if(parseInt(value)!=value){
		alert(name+ &quot;必须是整数&quot;);
		$(&quot;#&quot;+id)[0].focus();
		return false;
	}
	
	return true;
}
</code></pre>
<ol start="6">
<li>对于删除超链，都需要进行确认操作</li>
</ol>
<pre><code class="language-java">$(function(){
	$(&quot;a&quot;).click(function(){
		var deleteLink = $(this).attr(&quot;deleteLink&quot;);
		console.log(deleteLink);
		if(&quot;true&quot;==deleteLink){
			var confirmDelete = confirm(&quot;确认要删除&quot;);
			if(confirmDelete)
				return true;
			return false;
			
		}
	});
})
</code></pre>
<pre><code class="language-jsp">&lt;!DOCTYPE html&gt;
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;
&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/fmt&quot; prefix='fmt' %&gt;
 
&lt;html&gt;
 
&lt;head&gt;
    &lt;script src=&quot;js/jquery/2.0.0/jquery.min.js&quot;&gt;&lt;/script&gt;
    &lt;link href=&quot;css/bootstrap/3.3.6/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;
    &lt;script src=&quot;js/bootstrap/3.3.6/bootstrap.min.js&quot;&gt;&lt;/script&gt;
    &lt;link href=&quot;css/back/style.css&quot; rel=&quot;stylesheet&quot;&gt;
     
&lt;script&gt;
function checkEmpty(id, name){
    var value = $(&quot;#&quot;+id).val();
    if(value.length==0){
        alert(name+ &quot;不能为空&quot;);
        $(&quot;#&quot;+id)[0].focus();
        return false;
    }
    return true;
}
function checkNumber(id, name){
    var value = $(&quot;#&quot;+id).val();
    if(value.length==0){
        alert(name+ &quot;不能为空&quot;);
        $(&quot;#&quot;+id)[0].focus();
        return false;
    }
    if(isNaN(value)){
        alert(name+ &quot;必须是数字&quot;);
        $(&quot;#&quot;+id)[0].focus();
        return false;
    }
     
    return true;
}
function checkInt(id, name){
    var value = $(&quot;#&quot;+id).val();
    if(value.length==0){
        alert(name+ &quot;不能为空&quot;);
        $(&quot;#&quot;+id)[0].focus();
        return false;
    }
    if(parseInt(value)!=value){
        alert(name+ &quot;必须是整数&quot;);
        $(&quot;#&quot;+id)[0].focus();
        return false;
    }
     
    return true;
}
 
$(function(){
    $(&quot;a&quot;).click(function(){
        var deleteLink = $(this).attr(&quot;deleteLink&quot;);
        console.log(deleteLink);
        if(&quot;true&quot;==deleteLink){
            var confirmDelete = confirm(&quot;确认要删除&quot;);
            if(confirmDelete)
                return true;
            return false;
             
        }
    });
})
&lt;/script&gt;
&lt;/head&gt;
&lt;body&gt;
</code></pre>
<h3 id="步骤-3-adminNavigator-jsp"><a class="header-anchor" href="#步骤-3-adminNavigator-jsp">¶</a>步骤 3 : adminNavigator.jsp</h3>
<p><img src="3746.png" alt=""></p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;div class=&quot;navitagorDiv&quot;&gt;
    &lt;nav class=&quot;navbar navbar-default navbar-fixed-top navbar-inverse&quot;&gt;
        &lt;img style=&quot;margin-left:10px;margin-right:0px&quot; class=&quot;pull-left&quot; src=&quot;img/site/tmallbuy.png&quot; height=&quot;45px&quot;&gt;
        &lt;a class=&quot;navbar-brand&quot; href=&quot;#nowhere&quot;&gt;天猫后台&lt;/a&gt;
         
        &lt;a class=&quot;navbar-brand&quot; href=&quot;admin_category_list&quot;&gt;分类管理&lt;/a&gt;
        &lt;a class=&quot;navbar-brand&quot; href=&quot;admin_user_list&quot;&gt;用户管理&lt;/a&gt;
        &lt;a class=&quot;navbar-brand&quot; href=&quot;admin_order_list&quot;&gt;订单管理&lt;/a&gt;
    &lt;/nav&gt;
&lt;/div&gt;
</code></pre>
<h3 id="步骤-4-adminPage-jsp"><a class="header-anchor" href="#步骤-4-adminPage-jsp">¶</a>步骤 4 : adminPage.jsp</h3>
<p>这是分页JSP。<br>
分页功能不仅仅有前端效果，还需要结合服务端传递过来的数据综合才能起作用。 所以对于adminPage.jsp不在此展开讲解，将在后面的[分页]部分，结合服务端，专门讲解</p>
<p><img src="3747.png" alt=""></p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;script&gt;
$(function(){
    $(&quot;ul.pagination li.disabled a&quot;).click(function(){
        return false;
    });
});
 
&lt;/script&gt;
 
&lt;nav&gt;
  &lt;ul class=&quot;pagination&quot;&gt;
    &lt;li &lt;c:if test=&quot;${!page.hasPreviouse}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a  href=&quot;?page.start=0${page.param}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
 
    &lt;li &lt;c:if test=&quot;${!page.hasPreviouse}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a  href=&quot;?page.start=${page.start-page.count}${page.param}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;‹&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;   
 
    &lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
     
        &lt;c:if test=&quot;${status.count*page.count-page.start&lt;=20 &amp;&amp; status.count*page.count-page.start&gt;=-10}&quot;&gt;
            &lt;li &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
                &lt;a 
                href=&quot;?page.start=${status.index*page.count}${page.param}&quot;
                &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;current&quot;&lt;/c:if&gt;
                &gt;${status.count}&lt;/a&gt;
            &lt;/li&gt;
        &lt;/c:if&gt;
    &lt;/c:forEach&gt;
 
    &lt;li &lt;c:if test=&quot;${!page.hasNext}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a href=&quot;?page.start=${page.start+page.count}${page.param}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;›&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
    &lt;li &lt;c:if test=&quot;${!page.hasNext}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a href=&quot;?page.start=${page.last}${page.param}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
</code></pre>
<h3 id="步骤-5-adminFooter-jsp"><a class="header-anchor" href="#步骤-5-adminFooter-jsp">¶</a>步骤 5 : adminFooter.jsp</h3>
<p>页脚部分，目前是留白。 大家掌握了之后，可以写自己的名字@myname, 年份，版本信息什么的。</p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;div class=&quot;footer&quot;&gt;
&lt;/div&gt;
 
&lt;/body&gt;
&lt;/html&gt;
</code></pre>
<h2 id="6、查询"><a class="header-anchor" href="#6、查询">¶</a>6、查询</h2>
<h3 id="步骤-1-页面效果"><a class="header-anchor" href="#步骤-1-页面效果">¶</a>步骤 1 : 页面效果</h3>
<p>首先访问</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin_category_list
</code></pre>
<p>观看页面效果</p>
<p><img src="3752.png" alt=""></p>
<h3 id="步骤-2-MVC-设计思想"><a class="header-anchor" href="#步骤-2-MVC-设计思想">¶</a>步骤 2 : MVC 设计思想</h3>
<p>根据 [MVC设计模式]的思想，做J2EE web应用，从MVC的角度来看，就是把不同的数据显示在不同的页面上。</p>
<p>数据就是 <strong>模型</strong> ( bean, dao )<br>
页面就是 <strong>视图</strong> ( jsp )<br>
控制不同的模型显示在不同的视图上，这件事，就是由控制器来完成 ( servlet )</p>
<p>所以分类管理，从MVC的角度来看，就是把多条分类Category数据放在一个集合里， 让listCategory.jsp 这个视图去显示出来。</p>
<p><img src="3753.png" alt=""></p>
<h3 id="步骤-3-list-方法"><a class="header-anchor" href="#步骤-3-list-方法">¶</a>步骤 3 : list()方法</h3>
<p>根据[filter+servlet的设计模式]，访问地址</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin_category_list
</code></pre>
<p>会导致CategoryServlet的list方法被调用。<br>
根据[MVC 设计思想]，CategoryServlet充当的是C-控制器的角色<br>
那么在list()方法里做的事情是，取出数据，并且交由jsp显示。</p>
<p>第二行： 通过categoryDAO取得数据集合 cs<br>
第六行： 通过request.setAttribute 放在 “thecs&quot; 这个key中，为后续服务端跳转到jsp之后使用。<br>
第九行：return “admin/listCategory.jsp”; 服务端跳转到视图listCategory.jsp页面。</p>
<p><strong>注：</strong> CategoryServlet的list()方法中可以直接使用categoryDAO，是因为其父类BaseBackServlet在属性中声明了</p>
<pre><code class="language-java">protected CategoryDAO categoryDAO = new CategoryDAO();
</code></pre>
<p>作为BaseBackServlet的子类，CategoryServlet可以直接使用该protected 修饰的属性</p>
<p>除此之外，list里还有page对象，这是关于分页功能的，将在[分页]中单独讲解。</p>
<pre><code class="language-java">public String list(HttpServletRequest request, HttpServletResponse response, Page page) {
    List&lt;Category&gt; cs = categoryDAO.list(page.getStart(),page.getCount());
    int total = categoryDAO.getTotal();
    page.setTotal(total);
     
    request.setAttribute(&quot;thecs&quot;, cs);
    request.setAttribute(&quot;page&quot;, page);
     
    return &quot;admin/listCategory.jsp&quot;;
}
</code></pre>
<h3 id="步骤-4-服务端跳转"><a class="header-anchor" href="#步骤-4-服务端跳转">¶</a>步骤 4 : 服务端跳转</h3>
<p>list()方法返回字符串 “admin/listCategory.jsp” 就导致服务端跳转到了页面 “admin/listCategory.jsp”。<br>
为什么返回这个字符串，就可以实现[服务端跳转]呢？ 在servlet中进行服务端跳转不是要如下代码格式吗？</p>
<pre><code class="language-java">request.getRequestDispatcher(&quot;xxx.jsp&quot;).forward(request, response);
</code></pre>
<p>这个就要结合CategoryServlet的父类BaseBackServlet来理解了。<br>
在BaseBackServlet的70行，在借助反射机制调用了list()方法之后，获取返回值redirect.</p>
<p>如果redirect是以@开头的字符串，那么就进行客户端跳转<br>
如果redirect是以%开头的字符串，那么就直接输出字符串<br>
如果都不是，则进行服务端跳转</p>
<pre><code class="language-java">String redirect = m.invoke(this,request, response,page).toString();
             
            /*根据方法的返回值，进行相应的客户端跳转，服务端跳转，或者仅仅是输出字符串*/
             
            if(redirect.startsWith(&quot;@&quot;))
                response.sendRedirect(redirect.substring(1));
            else if(redirect.startsWith(&quot;%&quot;))
                response.getWriter().print(redirect.substring(1));
            else
                request.getRequestDispatcher(redirect).forward(request, response);
</code></pre>
<h3 id="步骤-5-listCategory-jsp"><a class="header-anchor" href="#步骤-5-listCategory-jsp">¶</a>步骤 5 : listCategory.jsp</h3>
<p>最后就是视图listCategory.jsp了。<br>
在[JSP包含关系]中已经讲解过了listCategory.jsp中包含的jsp文件，这里就不做赘述。<br>
本步骤就关注在listCategory.jsp主体内容是如何工作的。<br>
作为视图，担当的角色是显示数据。所以关键就是从第44行开始，借助JSTL的c:forEach标签遍历从CategoryServlet的list() 的request.setAttribute(“<strong>thecs</strong>”, cs); 传递过来的集合。</p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; import=&quot;java.util.*&quot;%&gt;
  
&lt;%@ taglib uri=&quot;http://java.sun.com/jsp/jstl/core&quot; prefix=&quot;c&quot;%&gt;
&lt;%@include file=&quot;../include/admin/adminHeader.jsp&quot;%&gt;
&lt;%@include file=&quot;../include/admin/adminNavigator.jsp&quot;%&gt;
 
&lt;script&gt;
$(function(){
     
    $(&quot;#addForm&quot;).submit(function(){
        if(!checkEmpty(&quot;name&quot;,&quot;分类名称&quot;))
            return false;
        if(!checkEmpty(&quot;categoryPic&quot;,&quot;分类图片&quot;))
            return false;
        return true;
    });
});
 
&lt;/script&gt;
 
&lt;title&gt;分类管理&lt;/title&gt;
 
&lt;div class=&quot;workingArea&quot;&gt;
    &lt;h1 class=&quot;label label-info&quot; &gt;分类管理&lt;/h1&gt;
    &lt;br&gt;
    &lt;br&gt;
     
    &lt;div class=&quot;listDataTableDiv&quot;&gt;
        &lt;table class=&quot;table table-striped table-bordered table-hover  table-condensed&quot;&gt;
            &lt;thead&gt;
                &lt;tr class=&quot;success&quot;&gt;
                    &lt;th&gt;ID&lt;/th&gt;
                    &lt;th&gt;图片&lt;/th&gt;
                    &lt;th&gt;分类名称&lt;/th&gt;
&lt;!--                     &lt;th&gt;属性管理&lt;/th&gt; --&gt;
&lt;!--                     &lt;th&gt;产品管理&lt;/th&gt; --&gt;
                    &lt;th&gt;编辑&lt;/th&gt;
                    &lt;th&gt;删除&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                &lt;c:forEach items=&quot;${thecs}&quot; var=&quot;c&quot;&gt;
                 
                &lt;tr&gt;
                    &lt;td&gt;${c.id}&lt;/td&gt;
                    &lt;td&gt;&lt;img height=&quot;40px&quot; src=&quot;img/category/${c.id}.jpg&quot;&gt;&lt;/td&gt;
                    &lt;td&gt;${c.name}&lt;/td&gt;
                         
&lt;%--                     &lt;td&gt;&lt;a href=&quot;admin_property_list?cid=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-th-list&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;                     --%&gt;
&lt;%--                     &lt;td&gt;&lt;a href=&quot;admin_product_list?cid=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-shopping-cart&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;                    --%&gt;
                    &lt;td&gt;&lt;a href=&quot;admin_category_edit?id=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;a deleteLink=&quot;true&quot; href=&quot;admin_category_delete?id=${c.id}&quot;&gt;&lt;span class=&quot;   glyphicon glyphicon-trash&quot;&gt;&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
     
                &lt;/tr&gt;
                &lt;/c:forEach&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/div&gt;
     
    &lt;div class=&quot;pageDiv&quot;&gt;
        &lt;%@include file=&quot;../include/admin/adminPage.jsp&quot; %&gt;
    &lt;/div&gt;
     
    &lt;div class=&quot;panel panel-warning addDiv&quot;&gt;
      &lt;div class=&quot;panel-heading&quot;&gt;新增分类&lt;/div&gt;
      &lt;div class=&quot;panel-body&quot;&gt;
            &lt;form method=&quot;post&quot; id=&quot;addForm&quot; action=&quot;admin_category_add&quot; enctype=&quot;multipart/form-data&quot;&gt;
                &lt;table class=&quot;addTable&quot;&gt;
                    &lt;tr&gt;
                        &lt;td&gt;分类名称&lt;/td&gt;
                        &lt;td&gt;&lt;input  id=&quot;name&quot; name=&quot;name&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td&gt;分类圖片&lt;/td&gt;
                        &lt;td&gt;
                            &lt;input id=&quot;categoryPic&quot; accept=&quot;image/*&quot; type=&quot;file&quot; name=&quot;filepath&quot; /&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr class=&quot;submitTR&quot;&gt;
                        &lt;td colspan=&quot;2&quot; align=&quot;center&quot;&gt;
                            &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;提 交&lt;/button&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/form&gt;
      &lt;/div&gt;
    &lt;/div&gt;
     
&lt;/div&gt;
 
&lt;%@include file=&quot;../include/admin/adminFooter.jsp&quot;%&gt;
</code></pre>
<h2 id="7、分页"><a class="header-anchor" href="#7、分页">¶</a>7、分页</h2>
<p>分页单独拿出来讲解</p>
<h3 id="步骤-1-效果-v8"><a class="header-anchor" href="#步骤-1-效果-v8">¶</a>步骤 1 : 效果</h3>
<p>默认是每页显示5条数据，所以先增加几条数据，以观察分页效果</p>
<p><img src="3758.png" alt=""></p>
<h3 id="步骤-2-Page-java"><a class="header-anchor" href="#步骤-2-Page-java">¶</a>步骤 2 : Page.java</h3>
<p>Page这个类专门为分页提供必要信息<br>
属性：<br>
int start; 开始位置<br>
int count; 每页显示的数量<br>
int total; 总共有多少条数据<br>
String param; 参数(这个属性在后续有用到，但是分类的分页查询里并没有用到，请忽略)</p>
<p>方法：<br>
getTotalPage 根据 每页显示的数量count以及总共有多少条数据total，计算出总共有多少页<br>
getLast 计算出最后一页的数值是多少<br>
isHasPreviouse 判断是否有前一页<br>
isHasNext 判断是否有后一页</p>
<pre><code class="language-java">package tmall.util;
 
public class Page {
    int start;
    int count;
    int total;
    String param;
    public int getStart() {
        return start;
    }
    public void setStart(int start) {
        this.start = start;
    }
    public int getCount() {
        return count;
    }
    public void setCount(int count) {
        this.count = count;
    }
    public Page(int start, int count) {
        super();
        this.start = start;
        this.count = count;
    }
     
    public boolean isHasPreviouse(){
        if(start==0)
            return false;
        return true;
         
    }
    public boolean isHasNext(){
        if(start==getLast())
            return false;
        return true;
    }
     
    public int getTotalPage(){
        int totalPage;
        // 假设总数是50，是能够被5整除的，那么就有10页
        if (0 == total % count)
            totalPage = total /count;
        // 假设总数是51，不能够被5整除的，那么就有11页
        else
            totalPage = total / count + 1;
         
        if(0==totalPage)
            totalPage = 1;
        return totalPage;
         
    }
     
    public int getLast(){
        int last;
        // 假设总数是50，是能够被5整除的，那么最后一页的开始就是45
        if (0 == total % count)
            last = total - count;
        // 假设总数是51，不能够被5整除的，那么最后一页的开始就是50
        else
            last = total - total % count;
         
        last = last&lt;0?0:last;
        return last;
    }
     
    public int getTotal() {
        return total;
    }
    public void setTotal(int total) {
        this.total = total;
    }
    public String getParam() {
        return param;
    }
    public void setParam(String param) {
        this.param = param;
    }
     
}
</code></pre>
<h3 id="步骤-3-获取分页参数"><a class="header-anchor" href="#步骤-3-获取分页参数">¶</a>步骤 3 : 获取分页参数</h3>
<p>获取分页信息是在BaseBackServlet的service方法中</p>
<pre><code class="language-java">int start= 0;
int count = 5;
try {
	start = Integer.parseInt(request.getParameter(&quot;page.start&quot;));
} catch (Exception e) {
	
}
try {
	count = Integer.parseInt(request.getParameter(&quot;page.count&quot;));
} catch (Exception e) {
}
Page page = new Page(start,count);
</code></pre>
<p>获取网页上传递来的开始位置，以及每页需要显示的数量<br>
如果传递数据过来，开始位置取0，每页显示的数量取默认值：5.</p>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.InputStream;
 
import java.lang.reflect.Method;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
 
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
 
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.OrderItemDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.dao.PropertyDAO;
import tmall.dao.PropertyValueDAO;
import tmall.dao.ReviewDAO;
import tmall.dao.UserDAO;
import tmall.util.Page;
 
public abstract class BaseBackServlet extends HttpServlet {
 
    public abstract String add(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String delete(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String edit(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String update(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String list(HttpServletRequest request, HttpServletResponse response, Page page) ;
     
    protected CategoryDAO categoryDAO = new CategoryDAO();
    protected OrderDAO orderDAO = new OrderDAO();
    protected OrderItemDAO orderItemDAO = new OrderItemDAO();
    protected ProductDAO productDAO = new ProductDAO();
    protected ProductImageDAO productImageDAO = new ProductImageDAO();
    protected PropertyDAO propertyDAO = new PropertyDAO();
    protected PropertyValueDAO propertyValueDAO = new PropertyValueDAO();
    protected ReviewDAO reviewDAO = new ReviewDAO();
    protected UserDAO userDAO = new UserDAO();
 
    public void service(HttpServletRequest request, HttpServletResponse response) {
        try {
             
            /*获取分页信息*/
            int start= 0;
            int count = 5;
            try {
                start = Integer.parseInt(request.getParameter(&quot;page.start&quot;));
            } catch (Exception e) {
                 
            }
            try {
                count = Integer.parseInt(request.getParameter(&quot;page.count&quot;));
            } catch (Exception e) {
            }
            Page page = new Page(start,count);
             
            /*借助反射，调用对应的方法*/
            String method = (String) request.getAttribute(&quot;method&quot;);
            Method m = this.getClass().getMethod(method, javax.servlet.http.HttpServletRequest.class,
                    javax.servlet.http.HttpServletResponse.class,Page.class);
            String redirect = m.invoke(this,request, response,page).toString();
             
            /*根据方法的返回值，进行相应的客户端跳转，服务端跳转，或者仅仅是输出字符串*/
             
            if(redirect.startsWith(&quot;@&quot;))
                response.sendRedirect(redirect.substring(1));
            else if(redirect.startsWith(&quot;%&quot;))
                response.getWriter().print(redirect.substring(1));
            else
                request.getRequestDispatcher(redirect).forward(request, response);
             
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }
    public InputStream parseUpload(HttpServletRequest request, Map&lt;String, String&gt; params) {
            InputStream is =null;
            try {
                DiskFileItemFactory factory = new DiskFileItemFactory();
                ServletFileUpload upload = new ServletFileUpload(factory);
                // 设置上传文件的大小限制为10M
                factory.setSizeThreshold(1024 * 10240);
                  
                List items = upload.parseRequest(request);
                Iterator iter = items.iterator();
                while (iter.hasNext()) {
                    FileItem item = (FileItem) iter.next();
                    if (!item.isFormField()) {
                        // item.getInputStream() 获取上传文件的输入流
                        is = item.getInputStream();
                    } else {
                        String paramName = item.getFieldName();
                        String paramValue = item.getString();
                        paramValue = new String(paramValue.getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);
                        params.put(paramName, paramValue);
                    }
                }
                  
            } catch (Exception e) {
                e.printStackTrace();
            }
            return is;
        }
     
}
</code></pre>
<h3 id="步骤-4-基于分页参数，获取数据"><a class="header-anchor" href="#步骤-4-基于分页参数，获取数据">¶</a>步骤 4 : 基于分页参数，获取数据</h3>
<p>接着就通过反射，访问了CategoryServlet的list()方法，并在其中通过categoryDAO，基于page的start,和count值，获取分页数据。</p>
<pre><code class="language-java">List&lt;Category&gt; cs = categoryDAO.list(page.getStart(),page.getCount());
</code></pre>
<h3 id="步骤-5-为page对象设置总数"><a class="header-anchor" href="#步骤-5-为page对象设置总数">¶</a>步骤 5 : 为page对象设置总数</h3>
<p>除此之外，还为page对象添加了总数</p>
<pre><code class="language-java">int total = categoryDAO.getTotal();
page.setTotal(total);
</code></pre>
<p>为什么要加这个总数？ 因为在分页显示的时候，要依据这个总数来判断一共有多少页面，最后一页是多少。</p>
<p>接着通过</p>
<pre><code class="language-java">request.setAttribute(&quot;page&quot;, page);
</code></pre>
<p>把page对象，传参到了listCategory.jsp页面</p>
<h3 id="步骤-6-为了便于理解，先来一个简化了的adminPage-jsp"><a class="header-anchor" href="#步骤-6-为了便于理解，先来一个简化了的adminPage-jsp">¶</a>步骤 6 : 为了便于理解，先来一个简化了的adminPage.jsp</h3>
<p>在listCategory.jsp页面包含了分页专用jsp:adminPage.jsp<br>
在其中，依据page对象，进行分页超链元素的显示<br>
[完整版的adminPage.jsp]比较复杂，为了便于大家理解，我先把完整版的adminPage.jsp简化一下</p>
<p>首先，分页超链的效果，用的[Bootstrap的分页效果]来制作<br>
首页超链：</p>
<pre><code class="language-jsp">    &lt;li&gt;
      &lt;a  href=&quot;?page.start=0&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
</code></pre>
<p>上一页超链：</p>
<pre><code class="language-jsp">    &lt;li &gt;
      &lt;a  href=&quot;?page.start=${page.start-page.count}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;‹&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
</code></pre>
<p>下一页超链：</p>
<pre><code class="language-jsp">    &lt;li &gt;
      &lt;a href=&quot;?page.start=${page.start+page.count}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;›&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
</code></pre>
<p>最后一页</p>
<pre><code class="language-jsp">    &lt;li &gt;
      &lt;a href=&quot;?page.start=${page.last}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
</code></pre>
<p>中间页</p>
<pre><code class="language-jsp">    &lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
		    &lt;li&gt;
		    	&lt;a href=&quot;?page.start=${status.index*page.count}&quot; class=&quot;current&quot;&gt;${status.count}&lt;/a&gt;
		    &lt;/li&gt;
    &lt;/c:forEach&gt;
</code></pre>
<pre><code class="language-xml">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;script&gt;
$(function(){
    $(&quot;ul.pagination li.disabled a&quot;).click(function(){
        return false;
    });
});
 
&lt;/script&gt;
 
&lt;nav&gt;
  &lt;ul class=&quot;pagination&quot;&gt;
    &lt;li&gt;
      &lt;a  href=&quot;?page.start=0&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
 
    &lt;li &gt;
      &lt;a  href=&quot;?page.start=${page.start-page.count}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;‹&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;   
 
    &lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
            &lt;li&gt;
                &lt;a href=&quot;?page.start=${status.index*page.count}&quot; class=&quot;current&quot;&gt;${status.count}&lt;/a&gt;
            &lt;/li&gt;
 
    &lt;/c:forEach&gt;
 
    &lt;li &gt;
      &lt;a href=&quot;?page.start=${page.start+page.count}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;›&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
    &lt;li &gt;
      &lt;a href=&quot;?page.start=${page.last}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
</code></pre>
<h3 id="步骤-7-完整版的adminPage-jsp"><a class="header-anchor" href="#步骤-7-完整版的adminPage-jsp">¶</a>步骤 7 : 完整版的adminPage.jsp</h3>
<p>[简化的adminPage.jsp] 用于帮助大家理解，其存在的问题是，即便是没有下一页的数据了，下一页超链也可以点击，点出来的页面是空白的。(首页，上一页，下一页和最后一页都存在这个问题)</p>
<p>那么所谓的完整版的adminPage.jsp，就是对这些边界进行了处理。当没有下一页的时候，对应超链处于不可点击状态。</p>
<p>比如首页：<br>
当page.hasPreviouse为false的时候，为首页连接套用Bootstrap样式 disabled</p>
<pre><code class="language-jsp">    &lt;li &lt;c:if test=&quot;${!page.hasPreviouse}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a  href=&quot;?page.start=0${page.param}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;&amp;laquo;&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
</code></pre>
<p><strong>注：</strong> hasPreviouse会的导致isHasPreviouse()方法被调用，请参考[EL表达式获取JavaBean的属性]</p>
<p><img src="3764.png" alt=""></p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;script&gt;
$(function(){
    $(&quot;ul.pagination li.disabled a&quot;).click(function(){
        return false;
    });
});
 
&lt;/script&gt;
 
&lt;nav&gt;
  &lt;ul class=&quot;pagination&quot;&gt;
    &lt;li &lt;c:if test=&quot;${!page.hasPreviouse}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a  href=&quot;?page.start=0${page.param}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;«&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
 
    &lt;li &lt;c:if test=&quot;${!page.hasPreviouse}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a  href=&quot;?page.start=${page.start-page.count}${page.param}&quot; aria-label=&quot;Previous&quot; &gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;‹&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;   
 
    &lt;c:forEach begin=&quot;0&quot; end=&quot;${page.totalPage-1}&quot; varStatus=&quot;status&quot;&gt;
     
        &lt;c:if test=&quot;${status.count*page.count-page.start&lt;=20 &amp;&amp; status.count*page.count-page.start&gt;=-10}&quot;&gt;
            &lt;li &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
                &lt;a 
                href=&quot;?page.start=${status.index*page.count}${page.param}&quot;
                &lt;c:if test=&quot;${status.index*page.count==page.start}&quot;&gt;class=&quot;current&quot;&lt;/c:if&gt;
                &gt;${status.count}&lt;/a&gt;
            &lt;/li&gt;
        &lt;/c:if&gt;
    &lt;/c:forEach&gt;
 
    &lt;li &lt;c:if test=&quot;${!page.hasNext}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a href=&quot;?page.start=${page.start+page.count}${page.param}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;›&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
    &lt;li &lt;c:if test=&quot;${!page.hasNext}&quot;&gt;class=&quot;disabled&quot;&lt;/c:if&gt;&gt;
      &lt;a href=&quot;?page.start=${page.last}${page.param}&quot; aria-label=&quot;Next&quot;&gt;
        &lt;span aria-hidden=&quot;true&quot;&gt;»&lt;/span&gt;
      &lt;/a&gt;
    &lt;/li&gt;
  &lt;/ul&gt;
&lt;/nav&gt;
</code></pre>
<h2 id="8、增加"><a class="header-anchor" href="#8、增加">¶</a>8、增加</h2>
<h3 id="步骤-1-页面"><a class="header-anchor" href="#步骤-1-页面">¶</a>步骤 1 : 页面</h3>
<p>增加分类的页面是做在上[查询结果页面]的<br>
需要注意几点：</p>
<ol>
<li>form的action=“admin_category_add”，会导致访问CategoryServlet的add()方法</li>
<li>method=“post” 用于保证中文的正确提交</li>
<li>必须有enctype=“multipart/form-data”，这样才能上传文件</li>
<li>accept=“image/*” 这样把上传的文件类型限制在了图片</li>
</ol>
<p><img src="3765.png" alt=""></p>
<pre><code class="language-xml">&lt;div class=&quot;panel panel-warning addDiv&quot;&gt;
  &lt;div class=&quot;panel-heading&quot;&gt;新增分类&lt;/div&gt;
  &lt;div class=&quot;panel-body&quot;&gt;
        &lt;form method=&quot;post&quot; id=&quot;addForm&quot; action=&quot;admin_category_add&quot; enctype=&quot;multipart/form-data&quot;&gt;
            &lt;table class=&quot;addTable&quot;&gt;
                &lt;tr&gt;
                    &lt;td&gt;分类名称&lt;/td&gt;
                    &lt;td&gt;&lt;input  id=&quot;name&quot; name=&quot;name&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;分类圖片&lt;/td&gt;
                    &lt;td&gt;
                        &lt;input id=&quot;categoryPic&quot; accept=&quot;image/*&quot; type=&quot;file&quot; name=&quot;filepath&quot; /&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr class=&quot;submitTR&quot;&gt;
                    &lt;td colspan=&quot;2&quot; align=&quot;center&quot;&gt;
                        &lt;button type=&quot;submit&quot; class=&quot;btn btn-success&quot;&gt;提 交&lt;/button&gt;
                    &lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
        &lt;/form&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<h3 id="步骤-2-为空判断"><a class="header-anchor" href="#步骤-2-为空判断">¶</a>步骤 2 : 为空判断</h3>
<p>对分类名称和分类图片做了为空判断，当为空的时候，不能提交</p>
<p>其中用到的函数checkEmpty，在[adminHeader.jsp] 中定义</p>
<p><img src="3766.png" alt=""></p>
<pre><code class="language-jsp">&lt;script&gt;
$(function(){
     
    $(&quot;#addForm&quot;).submit(function(){
        if(!checkEmpty(&quot;name&quot;,&quot;分类名称&quot;))
            return false;
        if(!checkEmpty(&quot;categoryPic&quot;,&quot;分类图片&quot;))
            return false;
        return true;
    });
});
 
&lt;/script&gt;
</code></pre>
<h3 id="步骤-3-提交数据"><a class="header-anchor" href="#步骤-3-提交数据">¶</a>步骤 3 : 提交数据</h3>
<p>当填写了名称，并且选中了图片之后，就可以提交数据。<br>
提交数据会导致CategoryServlet.add()方法被调用</p>
<h3 id="步骤-4-接受数据并处理"><a class="header-anchor" href="#步骤-4-接受数据并处理">¶</a>步骤 4 : 接受数据并处理</h3>
<p>在add()方法中做了如下操作：</p>
<ol>
<li>parseUpload 获取上传文件的输入流</li>
<li>parseUpload 方法会修改params 参数，并且把浏览器提交的name信息放在其中</li>
<li>从params 中取出name信息，并根据这个name信息，借助categoryDAO，向数据库中插入数据。</li>
<li>根据request.getServletContext().getRealPath( “img/category”)，定位到存放分类图片的目录</li>
<li>文件命名以保存到数据库的分类对象的id+&quot;.jpg&quot;的格式命名</li>
<li>根据步骤1获取的输入流，把浏览器提交的文件，复制到目标文件</li>
<li>借助ImageUtil.change2jpg()方法把格式真正转化为jpg，而不仅仅是后缀名为.jpg</li>
</ol>
<p><strong>注：</strong> 为什么不能直接使用request.getParameter(“name”)的方式来获取数据？ 因为当浏览器提交的数据是二进制的时候，Servlet不能够通过这种方式直接获取参数。请参考 [上传文件时，Servlet 如何处理其他非File字段]<br>
<strong>注</strong> 为什么要用request.getServletContext().getRealPath( )的方式定位e:/project/tmall/web/img/category 这目录，而不是用硬编码写死？ 因为在部署到Linux 实际运行的时候，Linux上的目录就有是其他的路径了，比如 /usr/public/tmall/img/category，只有采用这种方式才能兼容<br>
<strong>注</strong> 第七步为什么要这么做？ 因为浏览器提交来的图片文件，有可能是png,gif,bmp等非jpg格式的图片。 仅仅修改文件的后缀名有可能会导致显示异常。借助 [ImageUtil工具类] 真正保证文件的格式是jpg的。</p>
<pre><code class="language-java">public String add(HttpServletRequest request, HttpServletResponse response, Page page) {
    Map&lt;String,String&gt; params = new HashMap&lt;&gt;();
    InputStream is = super.parseUpload(request, params);
     
    String name= params.get(&quot;name&quot;);
    Category c = new Category();
    c.setName(name);
    categoryDAO.add(c);
     
    File  imageFolder= new File(request.getSession().getServletContext().getRealPath(&quot;img/category&quot;));
    File file = new File(imageFolder,c.getId()+&quot;.jpg&quot;);
     
    try {
        if(null!=is &amp;&amp; 0!=is.available()){
            try(FileOutputStream fos = new FileOutputStream(file)){
                byte b[] = new byte[1024 * 1024];
                int length = 0;
                while (-1 != (length = is.read(b))) {
                    fos.write(b, 0, length);
                }
                fos.flush();
                //通过如下代码，把文件保存为jpg格式
                BufferedImage img = ImageUtil.change2jpg(file);
                ImageIO.write(img, &quot;jpg&quot;, file);       
            }
            catch(Exception e){
                e.printStackTrace();
            }
        }
    } catch (IOException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }  
    return &quot;@admin_category_list&quot;;
}
</code></pre>
<h3 id="步骤-5-ImageUtil工具类"><a class="header-anchor" href="#步骤-5-ImageUtil工具类">¶</a>步骤 5 : ImageUtil工具类</h3>
<p>ImageUtil 工具类提供3个方法</p>
<ol>
<li>
<p>change2jpg<br>
确保图片文件的二进制格式是jpg。<br>
仅仅通过ImageIO.write(img, “jpg”, file);不足以保证转换出来的jpg文件显示正常。这段转换代码，可以确保转换后jpg的图片显示正常，而不会出现暗红色( 有一定几率出现)。 我也是度娘上抄的，哈哈哈~ 不过找了很多代码哦，才找到这一段能真正生效，而且不会发生错误的。</p>
</li>
<li>
<p>后两种resizeImage用于改变图片大小，在上传产品图片的时候会用到。 这里不展开，到时候再讲</p>
</li>
</ol>
<pre><code class="language-java">package tmall.util;
 
import java.awt.Image;
import java.awt.Toolkit;
import java.awt.image.BufferedImage;
import java.awt.image.ColorModel;
import java.awt.image.DataBuffer;
import java.awt.image.DataBufferInt;
import java.awt.image.DirectColorModel;
import java.awt.image.PixelGrabber;
import java.awt.image.Raster;
import java.awt.image.RenderedImage;
import java.awt.image.WritableRaster;
import java.io.File;
import java.io.IOException;
 
import javax.imageio.ImageIO;
 
public class ImageUtil {
 
    public static BufferedImage change2jpg(File f) {
        try {
            java.awt.Image i = Toolkit.getDefaultToolkit().createImage(f.getAbsolutePath());
            PixelGrabber pg = new PixelGrabber(i, 0, 0, -1, -1, true);
            pg.grabPixels();
            int width = pg.getWidth(), height = pg.getHeight();
            final int[] RGB_MASKS = { 0xFF0000, 0xFF00, 0xFF };
            final ColorModel RGB_OPAQUE = new DirectColorModel(32, RGB_MASKS[0], RGB_MASKS[1], RGB_MASKS[2]);
            DataBuffer buffer = new DataBufferInt((int[]) pg.getPixels(), pg.getWidth() * pg.getHeight());
            WritableRaster raster = Raster.createPackedRaster(buffer, width, height, width, RGB_MASKS, null);
            BufferedImage img = new BufferedImage(RGB_OPAQUE, raster, false, null);
            return img;
        } catch (InterruptedException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
            return null;
        }
    }
 
    public static void resizeImage(File srcFile, int width,int height, File destFile) {
        try {
            Image i = ImageIO.read(srcFile);
            i = resizeImage(i, width, height);
            ImageIO.write((RenderedImage) i, &quot;jpg&quot;, destFile);
        } catch (IOException e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
    }
     
    public static Image resizeImage(Image srcImage, int width, int height) {
        try {
 
            BufferedImage buffImg = null;
            buffImg = new BufferedImage(width, height, BufferedImage.TYPE_INT_RGB);
            buffImg.getGraphics().drawImage(srcImage.getScaledInstance(width, height, Image.SCALE_SMOOTH), 0, 0, null);
 
            return buffImg;
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
        }
        return null;
    }
 
}
</code></pre>
<h3 id="步骤-6-中文问题"><a class="header-anchor" href="#步骤-6-中文问题">¶</a>步骤 6 : 中文问题</h3>
<p>中文问题，统一交由EncodingFilter来进行处理</p>
<pre><code class="language-java">request.setCharacterEncoding(&quot;UTF-8&quot;);
</code></pre>
<p>对提交的数据进行UTF-8编码。</p>
<p>其他的配合动作</p>
<ol>
<li>在jsp中要加上</li>
</ol>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; import=&quot;java.util.*&quot;%&gt;
</code></pre>
<p>其中contentType=&quot;text/html; charset=UTF-8&quot;的作用是告诉浏览器提交数据的时候，使用UTF-8编码</p>
<ol start="2">
<li>在form里method=“post” 才能正确提交中文</li>
</ol>
<p>参考： [使用Filter处理中文问题]</p>
<pre><code class="language-java">package tmall.filter;
  
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;
  
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
  
public class EncodingFilter implements Filter {
  
    @Override
    public void destroy() {
  
    }
  
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;
  
        request.setCharacterEncoding(&quot;UTF-8&quot;);
  
        chain.doFilter(request, response);
    }
  
    @Override
    public void init(FilterConfig arg0) throws ServletException {
  
    }
  
}
</code></pre>
<h3 id="布骤-7-客户端跳转"><a class="header-anchor" href="#布骤-7-客户端跳转">¶</a>布骤 7 : 客户端跳转</h3>
<p>最后，add() 方法里返回了</p>
<pre><code class="language-java">return &quot;@admin_category_list&quot;;
</code></pre>
<p>这样就客户端跳转到了页面：</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin_category_list
</code></pre>
<p>为什么这样就能进行客户端跳转？ 这部分逻辑在BaseBackServlet的service() 方法的72-78行：<br>
当返回值以&quot;@&quot;开头的时候，就进行客户端跳转response.sendRedirect(redirect.substring(1));</p>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.InputStream;
 
import java.lang.reflect.Method;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
 
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.fileupload.FileItem;
import org.apache.commons.fileupload.disk.DiskFileItemFactory;
import org.apache.commons.fileupload.servlet.ServletFileUpload;
 
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.OrderItemDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.dao.PropertyDAO;
import tmall.dao.PropertyValueDAO;
import tmall.dao.ReviewDAO;
import tmall.dao.UserDAO;
import tmall.util.Page;
 
public abstract class BaseBackServlet extends HttpServlet {
 
    public abstract String add(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String delete(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String edit(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String update(HttpServletRequest request, HttpServletResponse response, Page page) ;
    public abstract String list(HttpServletRequest request, HttpServletResponse response, Page page) ;
     
    protected CategoryDAO categoryDAO = new CategoryDAO();
    protected OrderDAO orderDAO = new OrderDAO();
    protected OrderItemDAO orderItemDAO = new OrderItemDAO();
    protected ProductDAO productDAO = new ProductDAO();
    protected ProductImageDAO productImageDAO = new ProductImageDAO();
    protected PropertyDAO propertyDAO = new PropertyDAO();
    protected PropertyValueDAO propertyValueDAO = new PropertyValueDAO();
    protected ReviewDAO reviewDAO = new ReviewDAO();
    protected UserDAO userDAO = new UserDAO();
 
    public void service(HttpServletRequest request, HttpServletResponse response) {
        try {
             
            /*获取分页信息*/
            int start= 0;
            int count = 5;
            try {
                start = Integer.parseInt(request.getParameter(&quot;page.start&quot;));
            } catch (Exception e) {
                 
            }
            try {
                count = Integer.parseInt(request.getParameter(&quot;page.count&quot;));
            } catch (Exception e) {
            }
            Page page = new Page(start,count);
             
            /*借助反射，调用对应的方法*/
            String method = (String) request.getAttribute(&quot;method&quot;);
            Method m = this.getClass().getMethod(method, javax.servlet.http.HttpServletRequest.class,
                    javax.servlet.http.HttpServletResponse.class,Page.class);
            String redirect = m.invoke(this,request, response,page).toString();
             
            /*根据方法的返回值，进行相应的客户端跳转，服务端跳转，或者仅仅是输出字符串*/
            if(redirect.startsWith(&quot;@&quot;))
                response.sendRedirect(redirect.substring(1));
            else if(redirect.startsWith(&quot;%&quot;))
                response.getWriter().print(redirect.substring(1));
            else
                request.getRequestDispatcher(redirect).forward(request, response);
             
        } catch (Exception e) {
            // TODO Auto-generated catch block
            e.printStackTrace();
            throw new RuntimeException(e);
        }
    }
    public InputStream parseUpload(HttpServletRequest request, Map&lt;String, String&gt; params) {
            InputStream is =null;
            try {
                DiskFileItemFactory factory = new DiskFileItemFactory();
                ServletFileUpload upload = new ServletFileUpload(factory);
                // 设置上传文件的大小限制为10M
                factory.setSizeThreshold(1024 * 10240);
                  
                List items = upload.parseRequest(request);
                Iterator iter = items.iterator();
                while (iter.hasNext()) {
                    FileItem item = (FileItem) iter.next();
                    if (!item.isFormField()) {
                        // item.getInputStream() 获取上传文件的输入流
                        is = item.getInputStream();
                    } else {
                        String paramName = item.getFieldName();
                        String paramValue = item.getString();
                        paramValue = new String(paramValue.getBytes(&quot;ISO-8859-1&quot;), &quot;UTF-8&quot;);
                        params.put(paramName, paramValue);
                    }
                }
                  
            } catch (Exception e) {
                e.printStackTrace();
            }
            return is;
        }
     
}
</code></pre>
<h2 id="9、删除"><a class="header-anchor" href="#9、删除">¶</a>9、删除</h2>
<h3 id="步骤-1-用于删除的超链"><a class="header-anchor" href="#步骤-1-用于删除的超链">¶</a>步骤 1 : 用于删除的超链</h3>
<p>用于删除的超链，指向地址admin_category_delete,并且会传递当前分类对象的id过去。</p>
<pre><code class="language-jsp">&lt;a deleteLink=&quot;true&quot; href=&quot;admin_category_delete?id=${c.id}&quot;&gt;&lt;span class=&quot; 	glyphicon glyphicon-trash&quot;&gt;&lt;/span&gt;&lt;/a&gt;
</code></pre>
<p><img src="3772.png" alt=""></p>
<h3 id="步骤-2-删除前的确认操作"><a class="header-anchor" href="#步骤-2-删除前的确认操作">¶</a>步骤 2 : 删除前的确认操作</h3>
<p>在[adminHeader.jsp] 中对所有的删除连接都进行了监听：</p>
<pre><code class="language-java">$(function(){
    $(&quot;a&quot;).click(function(){
        var deleteLink = $(this).attr(&quot;deleteLink&quot;);
        console.log(deleteLink);
        if(&quot;true&quot;==deleteLink){
            var confirmDelete = confirm(&quot;确认要删除&quot;);
            if(confirmDelete)
                return true;
            return false;
             
        }
    });
})
</code></pre>
<h3 id="步骤-3-删除调用CategoryServlet-delete-方法"><a class="header-anchor" href="#步骤-3-删除调用CategoryServlet-delete-方法">¶</a>步骤 3 : 删除调用CategoryServlet.delete()方法</h3>
<p>CategoryServlet.delete()方法里的逻辑很清晰：</p>
<ol>
<li>获取id</li>
<li>借助categoryDAO.delete()方法删除本id对应数据</li>
<li>客户端跳转到admin_category_list路径</li>
</ol>
<pre><code class="language-java">public String delete(HttpServletRequest request, HttpServletResponse response, Page page) {
    int id = Integer.parseInt(request.getParameter(&quot;id&quot;));
    categoryDAO.delete(id);
    return &quot;@admin_category_list&quot;;
}
</code></pre>
<h2 id="10、编辑"><a class="header-anchor" href="#10、编辑">¶</a>10、编辑</h2>
<h3 id="步骤-1-编辑页面"><a class="header-anchor" href="#步骤-1-编辑页面">¶</a>步骤 1 : 编辑页面</h3>
<p><img src="3775.png" alt=""></p>
<h3 id="步骤-2-编辑超链"><a class="header-anchor" href="#步骤-2-编辑超链">¶</a>步骤 2 : 编辑超链</h3>
<p>用于编辑的超链，指向地址admin_category_edit,并且会传递当前分类对象的id过去。</p>
<pre><code class="language-jsp">&lt;a href=&quot;admin_category_edit?id=${c.id}&quot;&gt;&lt;span class=&quot;glyphicon glyphicon-edit&quot;&gt;&lt;/span&gt;&lt;/a&gt;
</code></pre>
<p><img src="3776.png" alt=""></p>
<h3 id="步骤-3-调用CategoryServlet-edit-方法"><a class="header-anchor" href="#步骤-3-调用CategoryServlet-edit-方法">¶</a>步骤 3 : 调用CategoryServlet.edit()方法</h3>
<p>CategoryServlet.edit()方法的逻辑很清晰</p>
<ol>
<li>获取id</li>
<li>借助categoryDAO，根据id获取Category对象</li>
<li>把Category对象放在request里</li>
<li>服务端跳转到admin/editCategory.jsp 页面</li>
</ol>
<pre><code class="language-java">public String edit(HttpServletRequest request, HttpServletResponse response, Page page) {
    int id = Integer.parseInt(request.getParameter(&quot;id&quot;));
    Category c = categoryDAO.get(id);
    request.setAttribute(&quot;c&quot;, c);
    return &quot;admin/editCategory.jsp&quot;;       
}
</code></pre>
<h3 id="步骤-4-服务端跳转到editCategory-jsp页面"><a class="header-anchor" href="#步骤-4-服务端跳转到editCategory-jsp页面">¶</a>步骤 4 : 服务端跳转到editCategory.jsp页面</h3>
<p>在editCategory.jsp页面里，获取由CategoryServlet.edit() 通过request传递过来的Category对象，获取name和id，分别放在</p>
<pre><code class="language-jsp">&lt;input  id=&quot;name&quot; name=&quot;name&quot; value=&quot;${c.name}&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;
</code></pre>
<pre><code class="language-jsp">&lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;${c.id}&quot;&gt;
</code></pre>
<p>但是不能放在浏览图片这个input上。 因为浏览器不支持</p>
<pre><code class="language-jsp">&lt;input id=&quot;categoryPic&quot; accept=&quot;image/*&quot; type=&quot;file&quot; name=&quot;filepath&quot; /&gt;
</code></pre>
<p><img src="3778.png" alt=""></p>
<pre><code class="language-jsp">&lt;input  id=&quot;name&quot; name=&quot;name&quot; value=&quot;${c.name}&quot; type=&quot;text&quot; class=&quot;form-control&quot;&gt;
 
&lt;input type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;${c.id}&quot;&gt;
</code></pre>
<h2 id="11、修改"><a class="header-anchor" href="#11、修改">¶</a>11、修改</h2>
<h3 id="步骤-1-编辑页面提交数据"><a class="header-anchor" href="#步骤-1-编辑页面提交数据">¶</a>步骤 1 : 编辑页面提交数据</h3>
<p>编辑页面提交数据到admin_category_update</p>
<pre><code class="language-jsp">&lt;form method=&quot;post&quot; id=&quot;editForm&quot; action=&quot;admin_category_update&quot;  
enctype=&quot;multipart/form-data&quot;&gt;
</code></pre>
<ol>
<li>method=“post” 用于提交中文</li>
<li>enctype=“multipart/form-data” 用于提交二进制文件</li>
</ol>
<p><img src="3779.png" alt=""></p>
<h3 id="步骤-2-调用CategoryServlet-update-方法"><a class="header-anchor" href="#步骤-2-调用CategoryServlet-update-方法">¶</a>步骤 2 : 调用CategoryServlet.update()方法</h3>
<p>CategoryServlet.update() 方法和[CategoryServlet.add()]方法的处理很类似，有所不同之处在于[增加操作]一定会提交图片，而修改不一定提交图片。</p>
<p>在update()方法中做了如下操作：</p>
<ol>
<li>parseUpload 获取上传文件的输入流</li>
<li>parseUpload 方法会修改params 参数，并且把浏览器提交的name信息放在其中</li>
<li>从params 中取出id和name信息，并根据这个id,name信息，创建新的Category对象，并借助categoryDAO，向数据库中更新数据。</li>
<li>根据request.getServletContext().getRealPath( “img/category”)，定位到存放分类图片的目录</li>
<li>文件命名以保存到数据库的分类对象的id+&quot;.jpg&quot;的格式命名</li>
<li>如果通过parseUpload 获取到的输入流是空的，或者其中的可取字节数为0，那么就不进行上传处理</li>
</ol>
<pre><code class="language-java">if(null!=is &amp;&amp; 0!=is.available())
</code></pre>
<ol start="7">
<li>根据步骤1获取的输入流，把浏览器提交的文件，复制到目标文件</li>
<li>借助ImageUtil.change2jpg()方法把格式真正转化为jpg，而不仅仅是后缀名为.jpg</li>
<li>最后客户端跳转到admin_category_list</li>
</ol>
<p><strong>注：</strong> 为什么不能直接使用request.getParameter(“name”)的方式来获取数据？ 因为当浏览器提交的数据是二进制的时候，Servlet不能够通过这种方式直接获取参数。请参考 [上传文件时，Servlet 何处理其他非File字段]<br>
<strong>注</strong> 为什么要用request.getServletContext().getRealPath( )的方式定位e:/project/tmall/web/img/category 这目录，而不是用硬编码写死？ 因为在部署到Linux 实际运行的时候，Linux上的目录就有是其他的路径了，比如 /usr/public/tmall/img/category，只有采用这种方式才能兼容<br>
<strong>注</strong> 第八步为什么要这么做？ 因为浏览器提交来的图片文件，有可能是png,gif,bmp等非jpg格式的图片。 仅仅修改文件的后缀名有可能会导致显示异常。借助 [ImageUtil工具类]真正保证文件的格式是jpg的。</p>
<pre><code class="language-java">public String update(HttpServletRequest request, HttpServletResponse response, Page page) {
    Map&lt;String,String&gt; params = new HashMap&lt;&gt;();
    InputStream is = super.parseUpload(request, params);
     
    System.out.println(params);
    String name= params.get(&quot;name&quot;);
    int id = Integer.parseInt(params.get(&quot;id&quot;));
 
    Category c = new Category();
    c.setId(id);
    c.setName(name);
    categoryDAO.update(c);
     
    File  imageFolder= new File(request.getSession().getServletContext().getRealPath(&quot;img/category&quot;));
    File file = new File(imageFolder,c.getId()+&quot;.jpg&quot;);
    file.getParentFile().mkdirs();
     
    try {
        if(null!=is &amp;&amp; 0!=is.available()){
            try(FileOutputStream fos = new FileOutputStream(file)){
                byte b[] = new byte[1024 * 1024];
                int length = 0;
                while (-1 != (length = is.read(b))) {
                    fos.write(b, 0, length);
                }
                fos.flush();
                //閫氳繃濡備笅浠ｇ爜锛屾妸鏂囦欢淇濆瓨涓簀pg鏍煎紡
                BufferedImage img = ImageUtil.change2jpg(file);
                ImageIO.write(img, &quot;jpg&quot;, file);       
            }
            catch(Exception e){
                e.printStackTrace();
            }
        }
    } catch (IOException e) {
        // TODO Auto-generated catch block
        e.printStackTrace();
    }
    return &quot;@admin_category_list&quot;;
 
}
</code></pre>
<h2 id="12、做一遍"><a class="header-anchor" href="#12、做一遍">¶</a>12、做一遍</h2>
<p>关于分类管理这一块的学习，推荐如下思路：</p>
<ol>
<li>
<p>先下载[可运行的项目] ，配置好了跑一边</p>
</li>
<li>
<p>根据接着的讲解，把里面的每一块代码的逻辑，思路，设计思想搞明白，不明不白的在对应页面下提问</p>
</li>
<li>
<p>都理清楚之后，把[可运行的项目]删掉，按照：查询，增加，删除，编辑，修改的顺序自己从头到尾做一遍</p>
</li>
</ol>
<p>只有，能够独立的做出来，才叫做把这些知识点的内容转化为自己的技能</p>
