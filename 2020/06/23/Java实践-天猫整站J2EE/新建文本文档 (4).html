<h2 id="6、登录状态FILTER"><a class="header-anchor" href="#6、登录状态FILTER">¶</a>6、登录状态FILTER</h2>
<h3 id="步骤-1-先运行，看到效果，再学习"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错"><a class="header-anchor" href="#步骤-2-模仿和排错">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-查看购物车页面的问题"><a class="header-anchor" href="#步骤-3-查看购物车页面的问题">¶</a>步骤 3 : 查看购物车页面的问题</h3>
<p>[查看购物车页面]有个问题，必须建立在已经登录的状态之上。 如果没有登录，而访问地址：</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/forecart
</code></pre>
<p>会导致异常产生。</p>
<p><img src="3969.png" alt=""></p>
<h3 id="步骤-4-解决思路"><a class="header-anchor" href="#步骤-4-解决思路">¶</a>步骤 4 : 解决思路</h3>
<p>所以在查看购物车之前，应该进行登录操作，但是又不能确保用户一定会记得登录，那么怎么办呢？<br>
准备一个过滤器，当访问那些需要登录才能做的页面的时候，进行是否登录的判断，如果不通过，那么就跳转到login.jsp页面去，提示用户登录。</p>
<p>哪些页面需要登录？哪些页面不需要呢？<br>
a. 不需要登录也可以访问的<br>
如：注册，登录，产品，首页，分类，查询等等<br>
b. 需要登录才能够访问的<br>
如：购买行为，加入购物车行为，查看购物车，查看我的订单等等</p>
<h3 id="步骤-5-ForeAuthFilter"><a class="header-anchor" href="#步骤-5-ForeAuthFilter">¶</a>步骤 5 : ForeAuthFilter</h3>
<p>新建一个过滤器ForeAuthFilter，根据[解决思路]中</p>
<p>哪些页面需要登录？哪些页面不需要呢？<br>
a. 不需要登录也可以访问的<br>
如：注册，登录，产品，首页，分类，查询等等<br>
b. 需要登录才能够访问的<br>
如：购买行为，加入购物车行为，查看购物车，查看我的订单等等<br>
不需要登录也可以访问的已经确定了，但是需要登录才能够访问，截止目前为止还不能确定，所以这个过滤器就判断如果不是注册，登录，产品这些，就进行登录校验</p>
<ol>
<li>准备字符串数组 noNeedAuthPage，存放哪些不需要登录也能访问的路径</li>
<li>获取uri</li>
<li>去掉前缀/tmall</li>
<li>如果访问的地址是/fore开头，又不是/foreServlet<br>
4.1 取出fore后面的字符串，比如是forecart,那么就取出cart<br>
4.2 判断cart是否是在noNeedAuthPage<br>
4.2 如果不在，那么就需要进行是否登录验证<br>
4.3 从session中取出&quot;user&quot;对象<br>
4.4 如果对象不存在，就客户端跳转到login.jsp<br>
4.5 否则就正常执行</li>
</ol>
<pre><code class="language-java">package tmall.filter;
 
import java.io.IOException;
import java.util.Arrays;
import java.util.List;
 
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.StringUtils;
 
import tmall.bean.OrderItem;
import tmall.bean.User;
import tmall.dao.OrderItemDAO;
 
public class ForeAuthFilter implements Filter{
     
    @Override
    public void destroy() {
         
    }
 
    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain)
            throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) req;
        HttpServletResponse response = (HttpServletResponse) res;
        String contextPath=request.getServletContext().getContextPath();
 
        String[] noNeedAuthPage = new String[]{
                &quot;homepage&quot;,
                &quot;checkLogin&quot;,
                &quot;register&quot;,
                &quot;loginAjax&quot;,
                &quot;login&quot;,
                &quot;product&quot;,
                &quot;category&quot;,
                &quot;search&quot;};
         
        String uri = request.getRequestURI();
        uri =StringUtils.remove(uri, contextPath);
        if(uri.startsWith(&quot;/fore&quot;)&amp;&amp;!uri.startsWith(&quot;/foreServlet&quot;)){
            String method = StringUtils.substringAfterLast(uri,&quot;/fore&quot; );
            if(!Arrays.asList(noNeedAuthPage).contains(method)){
                User user =(User) request.getSession().getAttribute(&quot;user&quot;);
                if(null==user){
                    response.sendRedirect(&quot;login.jsp&quot;);
                    return;
                }
            }
        }
         
        chain.doFilter(request, response);
    }
 
    @Override
    public void init(FilterConfig arg0) throws ServletException {
         
    }
     
}
</code></pre>
<h3 id="步骤-6-web-xml"><a class="header-anchor" href="#步骤-6-web-xml">¶</a>步骤 6 : web.xml</h3>
<p>在web.xml增加对ForeAuthFilter的配置<br>
**注：**必须加在ForeServletFilter之前</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app&gt;
 
    &lt;servlet&gt;
        &lt;servlet-name&gt;ForeServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.ForeServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ForeServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/foreServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
     
    &lt;servlet&gt;
        &lt;servlet-name&gt;OrderServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.OrderServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;OrderServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/orderServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
     
    &lt;servlet&gt;
        &lt;servlet-name&gt;UserServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.UserServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;UserServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/userServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
     
    &lt;servlet&gt;
        &lt;servlet-name&gt;ProductImageServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.ProductImageServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ProductImageServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/productImageServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
     
    &lt;servlet&gt;
        &lt;servlet-name&gt;CategoryServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.CategoryServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
 
    &lt;servlet&gt;
        &lt;servlet-name&gt;ProductServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.ProductServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;ProductServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/productServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
      
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;CategoryServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/categoryServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
 
    &lt;servlet&gt;
        &lt;servlet-name&gt;PropertyServlet&lt;/servlet-name&gt;
        &lt;servlet-class&gt;tmall.servlet.PropertyServlet&lt;/servlet-class&gt;
    &lt;/servlet&gt;
  
    &lt;servlet-mapping&gt;
        &lt;servlet-name&gt;PropertyServlet&lt;/servlet-name&gt;
        &lt;url-pattern&gt;/propertyServlet&lt;/url-pattern&gt;
    &lt;/servlet-mapping&gt;
 
    &lt;filter&gt;
        &lt;filter-name&gt;EncodingFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;tmall.filter.EncodingFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
  
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;EncodingFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;   
     
    &lt;filter&gt;
        &lt;filter-name&gt;BackServletFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;tmall.filter.BackServletFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
  
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;BackServletFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
     
    &lt;filter&gt;
        &lt;filter-name&gt;ForeAuthFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;tmall.filter.ForeAuthFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
  
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;ForeAuthFilter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;     
 
    &lt;filter&gt;
        &lt;filter-name&gt;ForeServletFilter&lt;/filter-name&gt;
        &lt;filter-class&gt;tmall.filter.ForeServletFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
  
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;ForeServletFilter&lt;/filter-name&gt;
        &lt;dispatcher&gt;FORWARD&lt;/dispatcher&gt;
        &lt;dispatcher&gt;REQUEST&lt;/dispatcher&gt;       
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
     
&lt;/web-app&gt;
</code></pre>
<h2 id="7、购物车页面操作"><a class="header-anchor" href="#7、购物车页面操作">¶</a>7、购物车页面操作</h2>
<h3 id="步骤-1-先运行，看到效果，再学习-v2"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习-v2">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错-v2"><a class="header-anchor" href="#步骤-2-模仿和排错-v2">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-购物车页面操作"><a class="header-anchor" href="#步骤-3-购物车页面操作">¶</a>步骤 3 : 购物车页面操作</h3>
<p>购物车页面和服务端的交互主要是三个</p>
<ol>
<li>增加、减少某种产品的数量</li>
<li>删除某种产品</li>
<li>选中产品后，提交到结算页面</li>
</ol>
<p><img src="3898.png" alt=""></p>
<h3 id="步骤-4-调整订单数量"><a class="header-anchor" href="#步骤-4-调整订单数量">¶</a>步骤 4 : 调整订单数量</h3>
<p>点击增加或者减少按钮后，根据 [cartPage.jsp] 中的js代码，会通过Ajax访问/forechangeOrderItem路径，导致ForeServlet.changeOrderItem()方法被调用</p>
<ol>
<li>判断用户是否登录</li>
<li>获取pid和number</li>
<li>遍历出用户当前所有的未生成订单的OrderItem</li>
<li>根据pid找到匹配的OrderItem，并修改数量后更新到数据库</li>
<li>返回字符串&quot;success&quot;</li>
</ol>
<p><img src="3899.png" alt=""></p>
<pre><code class="language-java">var page = &quot;forechangeOrderItem&quot;;
    $.post(
            page,
            {&quot;pid&quot;:pid,&quot;number&quot;:num},
            function(result){
                if(&quot;success&quot;!=result){
                    location.href=&quot;login.jsp&quot;;
                }
            }
        );
</code></pre>
<pre><code class="language-java">public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
    User user =(User) request.getSession().getAttribute(&quot;user&quot;);
    if(null==user)
        return &quot;%fail&quot;;
 
    int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
    int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
    List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
    for (OrderItem oi : ois) {
        if(oi.getProduct().getId()==pid){
            oi.setNumber(number);
            orderItemDAO.update(oi);
            break;
        }
         
    }      
    return &quot;%success&quot;;
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
}
</code></pre>
<h3 id="步骤-5-删除订单项"><a class="header-anchor" href="#步骤-5-删除订单项">¶</a>步骤 5 : 删除订单项</h3>
<p>点击删除按钮后，根据 [cartPage.jsp] 中的js代码，会通过Ajax访问/foredeleteOrderItem路径，导致ForeServlet.deleteOrderItem方法被调用</p>
<ol>
<li>判断用户是否登录</li>
<li>获取oiid</li>
<li>删除oiid对应的OrderItem数据</li>
<li>返回字符串&quot;success&quot;</li>
</ol>
<p><img src="3900.png" alt=""></p>
<pre><code class="language-java">var page=&quot;foredeleteOrderItem&quot;;
$.post(
        page,
        {&quot;oiid&quot;:deleteOrderItemid},
        function(result){
            if(&quot;success&quot;==result){
                $(&quot;tr.cartProductItemTR[oiid=&quot;+deleteOrderItemid+&quot;]&quot;).hide();
            }
            else{
                location.href=&quot;login.jsp&quot;;
            }
        }
    );
</code></pre>
<pre><code class="language-java">public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
    User user =(User) request.getSession().getAttribute(&quot;user&quot;);
    if(null==user)
        return &quot;%fail&quot;;
    int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
    orderItemDAO.delete(oiid);
    return &quot;%success&quot;;
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
     
}
</code></pre>
<h3 id="步骤-6-提交到结算页面"><a class="header-anchor" href="#步骤-6-提交到结算页面">¶</a>步骤 6 : 提交到结算页面</h3>
<p>在选中了购物车中的任意商品之后，结算按钮呈现可点击状态。<br>
点击之后，提交到[结算页面]，并带上(多个)被选中的OrderItem对象的id</p>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/forebuy?oiid=2&amp;oiid=1
</code></pre>
<p>之后的流程就进入了前面讲解过的[结算页面]，在此不作赘述。</p>
<p><img src="3975.png" alt=""></p>
<h2 id="8、订单状态图"><a class="header-anchor" href="#8、订单状态图">¶</a>8、订单状态图</h2>
<h3 id="步骤-1-订单状态图"><a class="header-anchor" href="#步骤-1-订单状态图">¶</a>步骤 1 : 订单状态图</h3>
<p><img src="3978.png" alt=""></p>
<h3 id="步骤-2-订单状态讲解"><a class="header-anchor" href="#步骤-2-订单状态讲解">¶</a>步骤 2 : 订单状态讲解</h3>
<p>在开始实现订单相关功能之前，我们把订单的状态捋一捋，这样有助于代码思路更加清晰</p>
<ol>
<li>
<p>首先是创建订单，刚创建好之后，订单处于<strong>waitPay 待付款</strong>状态</p>
</li>
<li>
<p>接着是付款，付款后，订单处于<strong>waitDelivery 待发货</strong>状态</p>
</li>
<li>
<p>前两部都是前台用户操作导致的，接下来需要到后台做发货操作，发货后，订单处于<strong>waitConfirm 待确认收货</strong>状态</p>
</li>
<li>
<p>接着又是前台用户进行确认收货操作，操作之后，订单处于<strong>waitReview 待评价</strong>状态</p>
</li>
<li>
<p>最后进行评价，评价之后，订单处于<strong>finish 完成</strong>状态</p>
</li>
</ol>
<p>以上状态都是一个接一个的，不能跳状态进行。<br>
比较特殊的是，无论当前订单处于哪个状态，都可以进行删除操作。 像订单这样极其重要的业务数据，实际上是不运行真正从数据库中删除掉的，而是把状态标记为删除，以表示其被删掉了，所以在删除之后，订单处于 <strong>delete 已删除</strong>状态</p>
<h3 id="步骤-3-后续功能与订单状态的关系"><a class="header-anchor" href="#步骤-3-后续功能与订单状态的关系">¶</a>步骤 3 : 后续功能与订单状态的关系</h3>
<p>接下来的功能开发，其实就是创建订单，并且根据用户不同的操作，对其进行相应状态调整的一个过程。</p>
<h2 id="9、生成订单"><a class="header-anchor" href="#9、生成订单">¶</a>9、生成订单</h2>
<h3 id="步骤-1-先运行，看到效果，再学习-v3"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习-v3">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错-v3"><a class="header-anchor" href="#步骤-2-模仿和排错-v3">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-结算页操作"><a class="header-anchor" href="#步骤-3-结算页操作">¶</a>步骤 3 : 结算页操作</h3>
<p>首先通过[立即购买]或者[购物车的提交到结算页面]进入[结算页面]，然后点击提交订单</p>
<p><img src="3901.png" alt=""></p>
<h3 id="步骤-4-运行效果"><a class="header-anchor" href="#步骤-4-运行效果">¶</a>步骤 4 : 运行效果</h3>
<p>提交订单后，在数据库中生成一条Order记录。<br>
不仅如此，订单项的oid字段也会被设置为这条Order记录的id</p>
<p><img src="3902.png" alt=""></p>
<h3 id="步骤-5-ForeServlet-createOrder"><a class="header-anchor" href="#步骤-5-ForeServlet-createOrder">¶</a>步骤 5 : ForeServlet.createOrder</h3>
<p>提交订单访问路径 /forecreateOrder, 导致ForeServlet.createOrder 方法被调用</p>
<ol>
<li>从session中获取user对象</li>
<li>获取地址，邮编，收货人，用户留言等信息</li>
<li>根据当前时间加上一个4位随机数生成订单号</li>
<li>根据上述参数，创建订单对象</li>
<li>把订单状态设置为等待支付</li>
<li>加入到数据库</li>
<li>从session中获取订单项集合 ( 在[结算功能的ForeServlet.buy() 13行]，订单项集合被放到了session中 )</li>
<li>遍历订单项集合，设置每个订单项的order，并更新到数据库</li>
<li>统计本次订单的总金额</li>
<li>客户端跳转到确认支付页forealipay，并带上订单id和总金额</li>
</ol>
<pre><code class="language-java">public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
    User user =(User) request.getSession().getAttribute(&quot;user&quot;);
     
    List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);
    if(ois.isEmpty())
        return &quot;@login.jsp&quot;;
 
    String address = request.getParameter(&quot;address&quot;);
    String post = request.getParameter(&quot;post&quot;);
    String receiver = request.getParameter(&quot;receiver&quot;);
    String mobile = request.getParameter(&quot;mobile&quot;);
    String userMessage = request.getParameter(&quot;userMessage&quot;);
     
    Order order = new Order();
    String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
 
    order.setOrderCode(orderCode);
    order.setAddress(address);
    order.setPost(post);
    order.setReceiver(receiver);
    order.setMobile(mobile);
    order.setUserMessage(userMessage);
    order.setCreateDate(new Date());
    order.setUser(user);
    order.setStatus(OrderDAO.waitPay);
 
    orderDAO.add(order);
    float total =0;
    for (OrderItem oi: ois) {
        oi.setOrder(order);
        orderItemDAO.update(oi);
        total+=oi.getProduct().getPromotePrice()*oi.getNumber();
    }
     
    return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
         
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);
        if(ois.isEmpty())
            return &quot;@login.jsp&quot;;
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        Order order = new Order();
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
 
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
     
}
</code></pre>
<h3 id="步骤-6-确认支付页"><a class="header-anchor" href="#步骤-6-确认支付页">¶</a>步骤 6 : 确认支付页</h3>
<ol>
<li>在上一步客户端跳转到路径/forealipay方法，导致ForeServlet.alipay()方法被调用。 alipay()没做什么事情，就是服务端跳转到了alipay.jsp页面。</li>
<li>alipay.jsp :<br>
与 [register.jsp] 相仿，alipay.jsp也包含了[header.jsp], [top.jsp]， [footer.jsp] 等公共页面。<br>
中间是确认支付业务页面 alipayPage.jsp</li>
<li>alipayPage.jsp:<br>
显示总金额，并且让确认支付按钮跳转到页面 /forepayed页面，并带上oid和金额</li>
</ol>
<p><img src="3903.png" alt=""></p>
<pre><code class="language-java">public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
    return &quot;alipay.jsp&quot;;
}
</code></pre>
<pre><code class="language-jsp">//alipay.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/alipayPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<pre><code class="language-jsp">//alipayPage.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
     
&lt;div class=&quot;aliPayPageDiv&quot;&gt;
    &lt;div class=&quot;aliPayPageLogo&quot;&gt;
        &lt;img class=&quot;pull-left&quot; src=&quot;img/site/simpleLogo.png&quot;&gt;
        &lt;div style=&quot;clear:both&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
     
    &lt;div&gt;
        &lt;span class=&quot;confirmMoneyText&quot;&gt;扫一扫付款（元）&lt;/span&gt;
        &lt;span class=&quot;confirmMoney&quot;&gt;
        ￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${param.total}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/span&gt;
         
    &lt;/div&gt;
    &lt;div&gt;
        &lt;img class=&quot;aliPayImg&quot; src=&quot;img/site/alipay2wei.png&quot;&gt;
    &lt;/div&gt;
 
    &lt;div&gt;
        &lt;a href=&quot;forepayed?oid=${param.oid}&amp;total=${param.total}&quot;&gt;&lt;button class=&quot;confirmPay&quot;&gt;确认支付&lt;/button&gt;&lt;/a&gt;
    &lt;/div&gt;
 
&lt;/div&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
     
}
</code></pre>
<h3 id="步骤-7-支付成功页"><a class="header-anchor" href="#步骤-7-支付成功页">¶</a>步骤 7 : 支付成功页</h3>
<ol>
<li>在上一步确认访问按钮提交数据到/forepayed,导致ForeServlet.payed方法被调用<br>
1.1 获取参数oid<br>
1.2 根据oid获取到订单对象order<br>
1.3 修改订单对象的状态和支付时间<br>
1.4 更新这个订单对象到数据库<br>
1.5 把这个订单对象放在request的属性&quot;o&quot;上<br>
1.6 服务端跳转到payed.jsp</li>
<li>payed.jsp<br>
与 [register.jsp] 相仿，payed.jsp也包含了[header.jsp], [top.jsp], [simpleSearch.jsp]， [footer.jsp] 等公共页面。<br>
中间是支付成功业务页面 payedPage.jsp</li>
<li>payedPage.jsp<br>
显示订单中的地址，邮编，收货人，手机号码等等</li>
</ol>
<p><img src="3904.png" alt=""></p>
<pre><code class="language-java">public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order order = orderDAO.get(oid);
    order.setStatus(OrderDAO.waitDelivery);
    order.setPayDate(new Date());
    new OrderDAO().update(order);
    request.setAttribute(&quot;o&quot;, order);
    return &quot;payed.jsp&quot;;    
}  
</code></pre>
<pre><code class="language-jsp">//payed.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/simpleSearch.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/payedPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<pre><code class="language-jsp">//payedPage.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
     
&lt;div class=&quot;payedDiv&quot;&gt;
    &lt;div class=&quot;payedTextDiv&quot;&gt;
        &lt;img src=&quot;img/site/paySuccess.png&quot;&gt;
        &lt;span&gt;您已成功付款&lt;/span&gt;
         
    &lt;/div&gt;
    &lt;div class=&quot;payedAddressInfo&quot;&gt;
        &lt;ul&gt;
            &lt;li&gt;收货地址：${o.address} ${o.receiver} ${o.mobile }&lt;/li&gt;
            &lt;li&gt;实付款：&lt;span class=&quot;payedInfoPrice&quot;&gt;
            ￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${param.total}&quot; minFractionDigits=&quot;2&quot;/&gt;
            &lt;/li&gt;
            &lt;li&gt;预计08月08日送达    &lt;/li&gt;
        &lt;/ul&gt;
                 
        &lt;div class=&quot;paedCheckLinkDiv&quot;&gt;
            您可以
            &lt;a class=&quot;payedCheckLink&quot; href=&quot;forebought&quot;&gt;查看已买到的宝贝&lt;/a&gt;
            &lt;a class=&quot;payedCheckLink&quot; href=&quot;forebought&quot;&gt;查看交易详情 &lt;/a&gt;
        &lt;/div&gt;
             
    &lt;/div&gt;
     
    &lt;div class=&quot;payedSeperateLine&quot;&gt;
    &lt;/div&gt;
     
    &lt;div class=&quot;warningDiv&quot;&gt;
        &lt;img src=&quot;img/site/warning.png&quot;&gt;
        &lt;b&gt;安全提醒：&lt;/b&gt;下单后，&lt;span class=&quot;redColor boldWord&quot;&gt;用QQ给您发送链接办理退款的都是骗子！&lt;/span&gt;天猫不存在系统升级，订单异常等问题，谨防假冒客服电话诈骗！
    &lt;/div&gt;
 
&lt;/div&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
     
}
</code></pre>
<h2 id="10、我的订单页"><a class="header-anchor" href="#10、我的订单页">¶</a>10、我的订单页</h2>
<h3 id="步骤-1-先运行，看到效果，再学习-v4"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习-v4">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错-v4"><a class="header-anchor" href="#步骤-2-模仿和排错-v4">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-我的订单页"><a class="header-anchor" href="#步骤-3-我的订单页">¶</a>步骤 3 : 我的订单页</h3>
<p><img src="3905.png" alt=""></p>
<h3 id="步骤-4-ForeServlet-bought"><a class="header-anchor" href="#步骤-4-ForeServlet-bought">¶</a>步骤 4 : ForeServlet.bought()</h3>
<p>/forebought导致ForeServlet.bought()方法被调用</p>
<ol>
<li>通过session获取用户user</li>
<li>查询user所有的状态不是&quot;delete&quot; 的订单集合os</li>
<li>为这些订单填充订单项</li>
<li>把os放在request的属性&quot;os&quot;上</li>
<li>服务端跳转到bought.jsp</li>
</ol>
<pre><code class="language-java">public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
    User user =(User) request.getSession().getAttribute(&quot;user&quot;);
    List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
     
    orderItemDAO.fill(os);
     
    request.setAttribute(&quot;os&quot;, os);
     
    return &quot;bought.jsp&quot;;       
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
     
}
</code></pre>
<h3 id="步骤-5-bought-jsp"><a class="header-anchor" href="#步骤-5-bought-jsp">¶</a>步骤 5 : bought.jsp</h3>
<p>与 [register.jsp] 相仿，bought.jsp 也包含了[header.jsp], [top.jsp], [simpleSearch.jsp]， [footer.jsp] 等公共页面。<br>
中间是我的订单页面 [boughtPage.jsp]</p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/simpleSearch.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/boughtPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<h3 id="步骤-6-boughtPage-jsp"><a class="header-anchor" href="#步骤-6-boughtPage-jsp">¶</a>步骤 6 : boughtPage.jsp</h3>
<p>在boughtPage.jsp中，从93行开始到172行，做二次遍历</p>
<ol>
<li>遍历订单集合os<br>
取出每个订单，显示其创建日期，订单号，总数量和总金额等</li>
<li>遍历每个订单下的订单项集合o.orderItemsd<br>
显示每个订单项对应的产品的图片，标题，原始价格，优惠价格等</li>
</ol>
<p><img src="3909.png" alt=""></p>
<pre><code class="language-jsp">&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;script&gt;
var deleteOrder = false;
var deleteOrderid = 0;
 
$(function(){
    $(&quot;a[orderStatus]&quot;).click(function(){
        var orderStatus = $(this).attr(&quot;orderStatus&quot;);
        if('all'==orderStatus){
            $(&quot;table[orderStatus]&quot;).show();
        }
        else{
            $(&quot;table[orderStatus]&quot;).hide();
            $(&quot;table[orderStatus=&quot;+orderStatus+&quot;]&quot;).show();        
        }
         
        $(&quot;div.orderType div&quot;).removeClass(&quot;selectedOrderType&quot;);
        $(this).parent(&quot;div&quot;).addClass(&quot;selectedOrderType&quot;);
    });
     
    $(&quot;a.deleteOrderLink&quot;).click(function(){
        deleteOrderid = $(this).attr(&quot;oid&quot;);
        deleteOrder = false;
        $(&quot;#deleteConfirmModal&quot;).modal(&quot;show&quot;);
    });
     
    $(&quot;button.deleteConfirmButton&quot;).click(function(){
        deleteOrder = true;
        $(&quot;#deleteConfirmModal&quot;).modal('hide');
    });
     
    $('#deleteConfirmModal').on('hidden.bs.modal', function (e) {
        if(deleteOrder){
            var page=&quot;foredeleteOrder&quot;;
            $.post(
                    page,
                    {&quot;oid&quot;:deleteOrderid},
                    function(result){
                        if(&quot;success&quot;==result){
                            $(&quot;table.orderListItemTable[oid=&quot;+deleteOrderid+&quot;]&quot;).hide();
                        }
                        else{
                            location.href=&quot;login.jsp&quot;;
                        }
                    }
                );
             
        }
    })     
     
    $(&quot;.ask2delivery&quot;).click(function(){
        var link = $(this).attr(&quot;link&quot;);
        $(this).hide();
        page = link;
        $.ajax({
               url: page,
               success: function(result){
                alert(&quot;卖家已秒发，刷新当前页面，即可进行确认收货&quot;)
               }
            });
         
    });
});
 
&lt;/script&gt;
     
&lt;div class=&quot;boughtDiv&quot;&gt;
    &lt;div class=&quot;orderType&quot;&gt;
        &lt;div class=&quot;selectedOrderType&quot;&gt;&lt;a orderStatus=&quot;all&quot; href=&quot;#nowhere&quot;&gt;所有订单&lt;/a&gt;&lt;/div&gt;
        &lt;div&gt;&lt;a  orderStatus=&quot;waitPay&quot; href=&quot;#nowhere&quot;&gt;待付款&lt;/a&gt;&lt;/div&gt;
        &lt;div&gt;&lt;a  orderStatus=&quot;waitDelivery&quot; href=&quot;#nowhere&quot;&gt;待发货&lt;/a&gt;&lt;/div&gt;
        &lt;div&gt;&lt;a  orderStatus=&quot;waitConfirm&quot; href=&quot;#nowhere&quot;&gt;待收货&lt;/a&gt;&lt;/div&gt;
        &lt;div&gt;&lt;a  orderStatus=&quot;waitReview&quot; href=&quot;#nowhere&quot; class=&quot;noRightborder&quot;&gt;待评价&lt;/a&gt;&lt;/div&gt;
        &lt;div class=&quot;orderTypeLastOne&quot;&gt;&lt;a class=&quot;noRightborder&quot;&gt; &lt;/a&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div style=&quot;clear:both&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;orderListTitle&quot;&gt;
        &lt;table class=&quot;orderListTitleTable&quot;&gt;
            &lt;tr&gt;
                &lt;td&gt;宝贝&lt;/td&gt;
                &lt;td width=&quot;100px&quot;&gt;单价&lt;/td&gt;
                &lt;td width=&quot;100px&quot;&gt;数量&lt;/td&gt;
                &lt;td width=&quot;120px&quot;&gt;实付款&lt;/td&gt;
                &lt;td width=&quot;100px&quot;&gt;交易操作&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
     
    &lt;/div&gt;
     
    &lt;div class=&quot;orderListItem&quot;&gt;
        &lt;c:forEach items=&quot;${os}&quot; var=&quot;o&quot;&gt;
            &lt;table class=&quot;orderListItemTable&quot; orderStatus=&quot;${o.status}&quot; oid=&quot;${o.id}&quot;&gt;
                &lt;tr class=&quot;orderListItemFirstTR&quot;&gt;
                    &lt;td colspan=&quot;2&quot;&gt;
                    &lt;b&gt;&lt;fmt:formatDate value=&quot;${o.createDate}&quot; pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;/&gt;&lt;/b&gt;
                    &lt;span&gt;订单号: ${o.orderCode}
                    &lt;/span&gt;
                    &lt;/td&gt;
                    &lt;td  colspan=&quot;2&quot;&gt;&lt;img width=&quot;13px&quot; src=&quot;img/site/orderItemTmall.png&quot;&gt;天猫商场&lt;/td&gt;
                    &lt;td colspan=&quot;1&quot;&gt;
                        &lt;a class=&quot;wangwanglink&quot; href=&quot;#nowhere&quot;&gt;
                            &lt;div class=&quot;orderItemWangWangGif&quot;&gt;&lt;/div&gt;
                        &lt;/a&gt;
                         
                    &lt;/td&gt;
                    &lt;td class=&quot;orderItemDeleteTD&quot;&gt;
                        &lt;a class=&quot;deleteOrderLink&quot; oid=&quot;${o.id}&quot; href=&quot;#nowhere&quot;&gt;
                            &lt;span  class=&quot;orderListItemDelete glyphicon glyphicon-trash&quot;&gt;&lt;/span&gt;
                        &lt;/a&gt;
                         
                    &lt;/td&gt;
                &lt;/tr&gt;
                &lt;c:forEach items=&quot;${o.orderItems}&quot; var=&quot;oi&quot; varStatus=&quot;st&quot;&gt;
                    &lt;tr class=&quot;orderItemProductInfoPartTR&quot; &gt;
                        &lt;td class=&quot;orderItemProductInfoPartTD&quot;&gt;&lt;img width=&quot;80&quot; height=&quot;80&quot; src=&quot;img/productSingle_middle/${oi.product.firstProductImage.id}.jpg&quot;&gt;&lt;/td&gt;
                        &lt;td class=&quot;orderItemProductInfoPartTD&quot;&gt;
                            &lt;div class=&quot;orderListItemProductLinkOutDiv&quot;&gt;
                                &lt;a href=&quot;foreproduct?pid=${oi.product.id}&quot;&gt;${oi.product.name}&lt;/a&gt;
                                &lt;div class=&quot;orderListItemProductLinkInnerDiv&quot;&gt;
                                            &lt;img src=&quot;img/site/creditcard.png&quot; title=&quot;支持信用卡支付&quot;&gt;
                                            &lt;img src=&quot;img/site/7day.png&quot; title=&quot;消费者保障服务,承诺7天退货&quot;&gt;
                                            &lt;img src=&quot;img/site/promise.png&quot; title=&quot;消费者保障服务,承诺如实描述&quot;&gt;                      
                                &lt;/div&gt;
                            &lt;/div&gt;
                        &lt;/td&gt;
                        &lt;td  class=&quot;orderItemProductInfoPartTD&quot; width=&quot;100px&quot;&gt;
                         
                            &lt;div class=&quot;orderListItemProductOriginalPrice&quot;&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${oi.product.orignalPrice}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/div&gt;
                            &lt;div class=&quot;orderListItemProductPrice&quot;&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${oi.product.promotePrice}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/div&gt;
         
                        &lt;/td&gt;
                        &lt;c:if test=&quot;${st.count==1}&quot;&gt;
                          
                            &lt;td valign=&quot;top&quot; rowspan=&quot;${fn:length(o.orderItems)}&quot; class=&quot;orderListItemNumberTD orderItemOrderInfoPartTD&quot; width=&quot;100px&quot;&gt;
                                &lt;span class=&quot;orderListItemNumber&quot;&gt;${o.totalNumber}&lt;/span&gt;
                            &lt;/td&gt;
                            &lt;td valign=&quot;top&quot; rowspan=&quot;${fn:length(o.orderItems)}&quot; width=&quot;120px&quot; class=&quot;orderListItemProductRealPriceTD orderItemOrderInfoPartTD&quot;&gt;
                                &lt;div class=&quot;orderListItemProductRealPrice&quot;&gt;￥&lt;fmt:formatNumber  minFractionDigits=&quot;2&quot;  maxFractionDigits=&quot;2&quot; type=&quot;number&quot; value=&quot;${o.total}&quot;/&gt;&lt;/div&gt;
                                &lt;div class=&quot;orderListItemPriceWithTransport&quot;&gt;(含运费：￥0.00)&lt;/div&gt;
                            &lt;/td&gt;
                            &lt;td valign=&quot;top&quot; rowspan=&quot;${fn:length(o.orderItems)}&quot; class=&quot;orderListItemButtonTD orderItemOrderInfoPartTD&quot; width=&quot;100px&quot;&gt;
                                &lt;c:if test=&quot;${o.status=='waitConfirm' }&quot;&gt;
                                    &lt;a href=&quot;foreconfirmPay?oid=${o.id}&quot;&gt;
                                        &lt;button class=&quot;orderListItemConfirm&quot;&gt;确认收货&lt;/button&gt;
                                    &lt;/a&gt;
                                &lt;/c:if&gt;
                                &lt;c:if test=&quot;${o.status=='waitPay' }&quot;&gt;
                                    &lt;a href=&quot;alipay.jsp?oid=${o.id}&amp;total=${o.total}&quot;&gt;
                                        &lt;button class=&quot;orderListItemConfirm&quot;&gt;付款&lt;/button&gt;
                                    &lt;/a&gt;                             
                                &lt;/c:if&gt;
                                 
                                &lt;c:if test=&quot;${o.status=='waitDelivery' }&quot;&gt;
                                    &lt;span&gt;待发货&lt;/span&gt;
&lt;%--                                     &lt;button class=&quot;btn btn-info btn-sm ask2delivery&quot; link=&quot;admin_order_delivery?id=${o.id}&quot;&gt;催卖家发货&lt;/button&gt; --%&gt;
                                     
                                &lt;/c:if&gt;
 
                                &lt;c:if test=&quot;${o.status=='waitReview' }&quot;&gt;
                                    &lt;a href=&quot;forereview?oid=${o.id}&quot;&gt;
                                        &lt;button  class=&quot;orderListItemReview&quot;&gt;评价&lt;/button&gt;
                                    &lt;/a&gt;
                                &lt;/c:if&gt;
                            &lt;/td&gt;                    
                        &lt;/c:if&gt;
                    &lt;/tr&gt;
                &lt;/c:forEach&gt;     
                 
            &lt;/table&gt;
        &lt;/c:forEach&gt;
         
    &lt;/div&gt;
     
&lt;/div&gt;
</code></pre>
<h2 id="11、我的订单页操作"><a class="header-anchor" href="#11、我的订单页操作">¶</a>11、我的订单页操作</h2>
<h3 id="步骤-1-先运行，看到效果，再学习-v5"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习-v5">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错-v5"><a class="header-anchor" href="#步骤-2-模仿和排错-v5">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-我的订单页面操作"><a class="header-anchor" href="#步骤-3-我的订单页面操作">¶</a>步骤 3 : 我的订单页面操作</h3>
<p>在我的订单页面，根据订单的不同状态，可以做出如下不同的操作：</p>
<ol>
<li>
<p>付款 —— 已经生成，但是未付款</p>
</li>
<li>
<p>确认收货 —— 通过[后台发货]后</p>
</li>
<li>
<p>评价 —— 确认收货后, 讲在[评价产品]知识点讲解，这里只是提到</p>
</li>
<li>
<p>删除 —— 任意状态下</p>
</li>
</ol>
<p><img src="3982.png" alt=""></p>
<h3 id="步骤-4-付款"><a class="header-anchor" href="#步骤-4-付款">¶</a>步骤 4 : 付款</h3>
<p>点击付款按钮直接跳转到在[生成订单]中的[确认支付页]环节，属于已经开发的功能，在此不作赘述。</p>
<p><img src="3984.png" alt=""></p>
<h3 id="步骤-5-确认收货"><a class="header-anchor" href="#步骤-5-确认收货">¶</a>步骤 5 : 确认收货</h3>
<ol>
<li>
<p>点击确认收货后，访问地址/foreconfirmPay</p>
</li>
<li>
<p>ForeServlet.confirmPay()方法被调用<br>
2.1 获取参数oid<br>
2.2 通过oid获取订单对象o<br>
2.3 为订单对象填充订单项<br>
2.4 把订单对象放在request的属性&quot;o&quot;上<br>
2.5 服务端跳转到 confirmPay.jsp</p>
</li>
<li>
<p>confirmPay.jsp<br>
与 [register.jsp] 相仿，confirmPay.jsp也包含了[header.jsp], [top.jsp], [simpleSearch.jsp]， [footer.jsp] 等公共页面。<br>
中间是订单确认业务页面 confirmPayPage.jsp</p>
</li>
<li>
<p>confirmPayPage.jsp<br>
显示订单的创建时间，付款时间和发货时间，以及订单号，收款人信息等<br>
遍历订单项集合，显示其中的产品图片，产品标题，价格，数量，小计，总结信息<br>
最后提供确认支付按钮，提交到/foreorderconfirmed路径</p>
</li>
</ol>
<p><img src="3985.png" alt=""></p>
<pre><code class="language-java">public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order o = orderDAO.get(oid);
    orderItemDAO.fill(o);
    request.setAttribute(&quot;o&quot;, o);
    return &quot;confirmPay.jsp&quot;;       
}
</code></pre>
<pre><code class="language-jsp">//comfirmPay.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/simpleSearch.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/confirmPayPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<pre><code class="language-jsp">////comfirmPayPage.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
     
&lt;div class=&quot;confirmPayPageDiv&quot;&gt;
    &lt;div class=&quot;confirmPayImageDiv&quot;&gt;
        &lt;img src=&quot;img/site/comformPayFlow.png&quot;&gt;
        &lt;div  class=&quot;confirmPayTime1&quot;&gt;
            &lt;fmt:formatDate value=&quot;${o.createDate}&quot; pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;/&gt;
        &lt;/div&gt;
        &lt;div  class=&quot;confirmPayTime2&quot;&gt;
            &lt;fmt:formatDate value=&quot;${o.payDate}&quot; pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;/&gt;
        &lt;/div&gt;
        &lt;div class=&quot;confirmPayTime3&quot;&gt;
            yyyy-MM-dd HH:mm:ss
        &lt;/div&gt;
         
    &lt;/div&gt;
    &lt;div class=&quot;confirmPayOrderInfoDiv&quot;&gt;
        &lt;div class=&quot;confirmPayOrderInfoText&quot;&gt;我已收到货，同意支付宝付款&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;confirmPayOrderItemDiv&quot;&gt;
        &lt;div class=&quot;confirmPayOrderItemText&quot;&gt;订单信息&lt;/div&gt;
        &lt;table class=&quot;confirmPayOrderItemTable&quot;&gt;
            &lt;thead&gt;
                &lt;th colspan=&quot;2&quot;&gt;宝贝&lt;/th&gt;    
                &lt;th width=&quot;120px&quot;&gt;单价&lt;/th&gt;      
                &lt;th width=&quot;120px&quot;&gt;数量&lt;/th&gt;      
                &lt;th width=&quot;120px&quot;&gt;商品总价 &lt;/th&gt;       
                &lt;th width=&quot;120px&quot;&gt;运费&lt;/th&gt;      
            &lt;/thead&gt;
            &lt;c:forEach items=&quot;${o.orderItems}&quot; var=&quot;oi&quot;&gt;
                &lt;tr&gt;
                    &lt;td&gt;&lt;img width=&quot;50px&quot; src=&quot;img/productSingle_middle/${oi.product.firstProductImage.id}.jpg&quot;&gt;&lt;/td&gt;
                    &lt;td class=&quot;confirmPayOrderItemProductLink&quot;&gt;
                        &lt;a href=&quot;#nowhere&quot;&gt;${oi.product.name}&lt;/a&gt;
                    &lt;/td&gt;
                    &lt;td&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${oi.product.orignalPrice}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/td&gt;
                    &lt;td&gt;1&lt;/td&gt;
                    &lt;td&gt;&lt;span class=&quot;conformPayProductPrice&quot;&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${oi.product.promotePrice}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/span&gt;&lt;/td&gt;
                    &lt;td&gt;&lt;span&gt;快递 ： 0.00 &lt;/span&gt;&lt;/td&gt;
                &lt;/tr&gt;
            &lt;/c:forEach&gt;
        &lt;/table&gt;
         
        &lt;div class=&quot;confirmPayOrderItemText pull-right&quot;&gt;
            实付款： &lt;span class=&quot;confirmPayOrderItemSumPrice&quot;&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${o.total}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/span&gt;
        &lt;/div&gt;
         
    &lt;/div&gt;
    &lt;div class=&quot;confirmPayOrderDetailDiv&quot;&gt;
         
        &lt;table class=&quot;confirmPayOrderDetailTable&quot;&gt;
            &lt;tr&gt;
                &lt;td&gt;订单编号：&lt;/td&gt;
                &lt;td&gt;${o.orderCode} &lt;img width=&quot;23px&quot; src=&quot;img/site/confirmOrderTmall.png&quot;&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;卖家昵称：&lt;/td&gt;
                &lt;td&gt;天猫商铺 &lt;span class=&quot;confirmPayOrderDetailWangWangGif&quot;&gt;&lt;/span&gt;&lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;收货信息： &lt;/td&gt;
                &lt;td&gt;${o.address}，${o.receiver}， ${o.mobile}，${o.post} &lt;/td&gt;
            &lt;/tr&gt;
            &lt;tr&gt;
                &lt;td&gt;成交时间：&lt;/td&gt;
                &lt;td&gt;&lt;fmt:formatDate value=&quot;${o.createDate}&quot; pattern=&quot;yyyy-MM-dd HH:mm:ss&quot;/&gt;&lt;/td&gt;
            &lt;/tr&gt;
        &lt;/table&gt;
         
    &lt;/div&gt;
    &lt;div class=&quot;confirmPayButtonDiv&quot;&gt;
        &lt;div class=&quot;confirmPayWarning&quot;&gt;请收到货后，再确认收货！否则您可能钱货两空！&lt;/div&gt;
        &lt;a href=&quot;foreorderConfirmed?oid=${o.id}&quot;&gt;&lt;button class=&quot;confirmPayButton&quot;&gt;确认支付&lt;/button&gt;&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
    public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        request.setAttribute(&quot;o&quot;, o);
        return &quot;confirmPay.jsp&quot;;       
    }
     
    public String orderconfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.waitReview);
        o.setConfirmDate(new Date());
        orderDAO.update(o);
        return &quot;orderConfirmed.jsp&quot;;
    }  
     
    public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
         
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.delete);
        orderDAO.update(o);
        return &quot;%success&quot;;     
    }  
}
</code></pre>
<h3 id="步骤-6-确认收货成功"><a class="header-anchor" href="#步骤-6-确认收货成功">¶</a>步骤 6 : 确认收货成功</h3>
<p>通过上一步最后的<strong>确认支付</strong>按钮，提交到路径/foreorderConfirmed，导致ForeServlet.orderConfirmed()方法被调用</p>
<ol>
<li>ForeServlet.orderConfirmed() 方法<br>
1.1 获取参数oid<br>
1.2 根据参数oid获取Order对象o<br>
1.3 修改对象o的状态为等待评价，修改其确认支付时间<br>
1.4 更新到数据库<br>
1.5 服务端跳转到orderConfirmed.jsp页面</li>
<li>orderConfirmed.jsp<br>
与 [register.jsp] 相仿，orderConfirmed.jsp也包含了[header.jsp], [top.jsp], [simpleSearch.jsp]， [footer.jsp] 等公共页面。<br>
中间是确认收货成功业务页面 orderConfirmedPage.jsp</li>
<li>orderConfirmedPage.jsp<br>
显示&quot;交易已经成功，卖家将收到您的货款。&quot;</li>
</ol>
<pre><code class="language-java">public String orderConfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order o = orderDAO.get(oid);
    o.setStatus(OrderDAO.waitReview);
    o.setConfirmDate(new Date());
    orderDAO.update(o);
    return &quot;orderConfirmed.jsp&quot;;
}
</code></pre>
<pre><code class="language-jsp">//orderConfirmed.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/simpleSearch.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/orderConfirmedPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<pre><code class="language-jsp">//orderConfirmedPage.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
     
&lt;div class=&quot;orderFinishDiv&quot;&gt;
    &lt;div class=&quot;orderFinishTextDiv&quot;&gt;
        &lt;img src=&quot;img/site/orderFinish.png&quot;&gt;
        &lt;span&gt;交易已经成功，卖家将收到您的货款。&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
    public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        request.setAttribute(&quot;o&quot;, o);
        return &quot;confirmPay.jsp&quot;;       
    }
     
    public String orderConfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.waitReview);
        o.setConfirmDate(new Date());
        orderDAO.update(o);
        return &quot;orderConfirmed.jsp&quot;;
    }  
     
    public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
         
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.delete);
        orderDAO.update(o);
        return &quot;%success&quot;;     
    }  
}
</code></pre>
<h3 id="步骤-7-评价"><a class="header-anchor" href="#步骤-7-评价">¶</a>步骤 7 : 评价</h3>
<p>点击评价按钮，跳转到路径/forereview,这部分单独开了个知识点[评价产品]进行讲解。</p>
<h3 id="步骤-8-删除"><a class="header-anchor" href="#步骤-8-删除">¶</a>步骤 8 : 删除</h3>
<p>在[我的订单页] 上点击删除按钮，根据 [boughtPage.jsp] 中的ajax操作，会访问路径/foredeleteOrder，导致ForeServlet.deleteOrder方法被调用</p>
<ol>
<li>ForeServlet.deleteOrder()<br>
1.1 获取参数oid<br>
1.2 根据oid获取订单对象o<br>
1.3 修改状态<br>
1.4 更新到数据库<br>
1.5 返回字符串&quot;success&quot;</li>
<li>[boughtPage.jsp] 中的javascript代码获取返回字符串是success的时候，隐藏掉当前这行订单数据。</li>
</ol>
<p><img src="3987.png" alt=""></p>
<pre><code class="language-java">var page=&quot;foredeleteOrder&quot;;
$.post(
        page,
        {&quot;oid&quot;:deleteOrderid},
        function(result){
            if(&quot;success&quot;==result){
                $(&quot;table.orderListItemTable[oid=&quot;+deleteOrderid+&quot;]&quot;).hide();
            }
            else{
                location.href=&quot;login.jsp&quot;;
            }
        }
    );
</code></pre>
<pre><code class="language-java">public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order o = orderDAO.get(oid);
    o.setStatus(OrderDAO.delete);
    orderDAO.update(o);
    return &quot;%success&quot;;     
}
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
    public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        request.setAttribute(&quot;o&quot;, o);
        return &quot;confirmPay.jsp&quot;;       
    }
     
    public String orderConfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.waitReview);
        o.setConfirmDate(new Date());
        orderDAO.update(o);
        return &quot;orderConfirmed.jsp&quot;;
    }  
     
    public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.delete);
        orderDAO.update(o);
        return &quot;%success&quot;;     
    }  
}
</code></pre>
<h2 id="12、评价产品"><a class="header-anchor" href="#12、评价产品">¶</a>12、评价产品</h2>
<h3 id="步骤-1-先运行，看到效果，再学习-v6"><a class="header-anchor" href="#步骤-1-先运行，看到效果，再学习-v6">¶</a>步骤 1 : 先运行，看到效果，再学习</h3>
<p>老规矩，先下载右上角的可运行项目，配置运行起来，确认可用之后，再学习做了哪些步骤以达到这样的效果。</p>
<h3 id="步骤-2-模仿和排错-v6"><a class="header-anchor" href="#步骤-2-模仿和排错-v6">¶</a>步骤 2 : 模仿和排错</h3>
<p>在确保可运行项目能够正确无误地运行之后，再严格照着教程的步骤，对代码模仿一遍。<br>
模仿过程难免代码有出入，导致无法得到期望的运行结果，此时此刻通过比较<strong>正确答案</strong> ( 可运行项目 ) 和自己的代码，来定位问题所在。<br>
采用这种方式，<strong>学习有效果，排错有效率</strong>，可以较为明显地提升学习速度，跨过学习路上的各个槛。</p>
<p>推荐使用diffmerge软件，进行文件夹比较。把你自己做的项目文件夹，和我的可运行项目文件夹进行比较。<br>
这个软件很牛逼的，可以知道文件夹里哪两个文件不对，并且很明显地标记出来<br>
这里提供了绿色安装和使用教程：[diffmerge 下载和使用教程]</p>
<h3 id="步骤-3-界面效果"><a class="header-anchor" href="#步骤-3-界面效果">¶</a>步骤 3 : 界面效果</h3>
<p><img src="3992.png" alt=""></p>
<h3 id="步骤-4-评价产品页面"><a class="header-anchor" href="#步骤-4-评价产品页面">¶</a>步骤 4 : 评价产品页面</h3>
<p>通过点击评价按钮，来到路径/forereview，导致ForeServlet.review()方法被调用</p>
<ol>
<li>ForeServlet.review()<br>
1.1 获取参数oid<br>
1.2 根据oid获取订单对象o<br>
1.3 为订单对象填充订单项<br>
1.4 获取第一个订单项对应的产品,因为在评价页面需要显示一个产品图片，那么就使用这第一个产品的图片了<br>
1.5 获取这个产品的评价集合<br>
1.6 为产品设置评价数量和销量<br>
1.7 把产品，订单和评价集合放在request上<br>
1.8 服务端跳转到 review.jsp</li>
<li>review.jsp<br>
与 [register.jsp] 相仿，review.jsp也包含了[header.jsp], [top.jsp], [simpleSearch.jsp]，<br>
[footer.jsp] 等公共页面。<br>
中间是产品业务页面 reviewPage.jsp</li>
<li>reviewPage.jsp<br>
在reviewPage.jsp中显示产品图片，产品标题，价格，产品销量，产品评价数量，以及订单信息等。<br>
同时还显示出了该产品所有的评价，但是默认是隐藏的</li>
</ol>
<p><img src="3990.png" alt=""></p>
<pre><code class="language-java">public String review(HttpServletRequest request, HttpServletResponse response, Page page) {
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order o = orderDAO.get(oid);
    orderItemDAO.fill(o);
    Product p = o.getOrderItems().get(0).getProduct();
    List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
    productDAO.setSaleAndReviewNumber(p);
    request.setAttribute(&quot;p&quot;, p);
    request.setAttribute(&quot;o&quot;, o);
    request.setAttribute(&quot;reviews&quot;, reviews);
    return &quot;review.jsp&quot;;       
}
</code></pre>
<pre><code class="language-jsp">//review.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
 
&lt;%@include file=&quot;include/header.jsp&quot;%&gt;
&lt;%@include file=&quot;include/top.jsp&quot;%&gt;
&lt;%@include file=&quot;include/simpleSearch.jsp&quot;%&gt;
&lt;%@include file=&quot;include/cart/reviewPage.jsp&quot;%&gt;
&lt;%@include file=&quot;include/footer.jsp&quot;%&gt;
</code></pre>
<pre><code class="language-jsp">//reviewPage.jsp
&lt;%@ page language=&quot;java&quot; contentType=&quot;text/html; charset=UTF-8&quot;
    pageEncoding=&quot;UTF-8&quot; isELIgnored=&quot;false&quot;%&gt;
     
&lt;div class=&quot;reviewDiv&quot;&gt;
    &lt;div class=&quot;reviewProductInfoDiv&quot;&gt;
        &lt;div class=&quot;reviewProductInfoImg&quot;&gt;&lt;img width=&quot;400px&quot; height=&quot;400px&quot; src=&quot;img/productSingle/${p.firstProductImage.id}.jpg&quot;&gt;&lt;/div&gt;
        &lt;div class=&quot;reviewProductInfoRightDiv&quot;&gt;
            &lt;div class=&quot;reviewProductInfoRightText&quot;&gt;
                ${p.name}
            &lt;/div&gt;
            &lt;table class=&quot;reviewProductInfoTable&quot;&gt;
                &lt;tr&gt;
                    &lt;td width=&quot;75px&quot;&gt;价格:&lt;/td&gt;
                    &lt;td&gt;&lt;span class=&quot;reviewProductInfoTablePrice&quot;&gt;￥&lt;fmt:formatNumber type=&quot;number&quot; value=&quot;${p.orignalPrice}&quot; minFractionDigits=&quot;2&quot;/&gt;&lt;/span&gt; 元 &lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;配送&lt;/td&gt;
                    &lt;td&gt;快递:  0.00&lt;/td&gt;
                &lt;/tr&gt;
                &lt;tr&gt;
                    &lt;td&gt;月销量:&lt;/td&gt;
                    &lt;td&gt;&lt;span class=&quot;reviewProductInfoTableSellNumber&quot;&gt;${p.saleCount}&lt;/span&gt; 件&lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
             
            &lt;div class=&quot;reviewProductInfoRightBelowDiv&quot;&gt;
                &lt;span class=&quot;reviewProductInfoRightBelowImg&quot;&gt;&lt;img1 src=&quot;img/site/reviewLight.png&quot;&gt;&lt;/span&gt;
                &lt;span class=&quot;reviewProductInfoRightBelowText&quot; &gt;现在查看的是 您所购买商品的信息
于&lt;fmt:formatDate value=&quot;${o.createDate}&quot; pattern=&quot;yyyy年MM月dd&quot;/&gt;下单购买了此商品 &lt;/span&gt;
             
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div style=&quot;clear:both&quot;&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;reviewStasticsDiv&quot;&gt;
        &lt;div class=&quot;reviewStasticsLeft&quot;&gt;
                &lt;div class=&quot;reviewStasticsLeftTop&quot;&gt;&lt;/div&gt;
                &lt;div class=&quot;reviewStasticsLeftContent&quot;&gt;累计评价 &lt;span class=&quot;reviewStasticsNumber&quot;&gt; ${p.reviewCount}&lt;/span&gt;&lt;/div&gt;
                &lt;div class=&quot;reviewStasticsLeftFoot&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
        &lt;div class=&quot;reviewStasticsRight&quot;&gt;
            &lt;div class=&quot;reviewStasticsRightEmpty&quot;&gt;&lt;/div&gt;
            &lt;div class=&quot;reviewStasticsFoot&quot;&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/div&gt;       
     
    &lt;c:if test=&quot;${param.showonly==true}&quot;&gt;
    &lt;div class=&quot;reviewDivlistReviews&quot;&gt;
        &lt;c:forEach items=&quot;${reviews}&quot; var=&quot;r&quot;&gt;
            &lt;div class=&quot;reviewDivlistReviewsEach&quot;&gt;
                &lt;div class=&quot;reviewDate&quot;&gt;&lt;fmt:formatDate value=&quot;${r.createDate}&quot; pattern=&quot;yyyy-MM-dd&quot;/&gt;&lt;/div&gt;
                &lt;div class=&quot;reviewContent&quot;&gt;${r.content}&lt;/div&gt;
                &lt;div class=&quot;reviewUserInfo pull-right&quot;&gt;${r.user.anonymousName}&lt;span class=&quot;reviewUserInfoAnonymous&quot;&gt;(匿名)&lt;/span&gt;&lt;/div&gt;
            &lt;/div&gt;
        &lt;/c:forEach&gt;
    &lt;/div&gt;
    &lt;/c:if&gt;
     
    &lt;c:if test=&quot;${param.showonly!=true}&quot;&gt;
        &lt;div class=&quot;makeReviewDiv&quot;&gt;
        &lt;form method=&quot;post&quot; action=&quot;foredoreview&quot;&gt;
            &lt;div class=&quot;makeReviewText&quot;&gt;其他买家，需要你的建议哦！&lt;/div&gt;
            &lt;table class=&quot;makeReviewTable&quot;&gt;
                &lt;tr&gt;
                    &lt;td class=&quot;makeReviewTableFirstTD&quot;&gt;评价商品&lt;/td&gt;
                    &lt;td&gt;&lt;textarea name=&quot;content&quot;&gt;&lt;/textarea&gt;&lt;/td&gt;
                &lt;/tr&gt;
            &lt;/table&gt;
            &lt;div class=&quot;makeReviewButtonDiv&quot;&gt;
                &lt;input type=&quot;hidden&quot; name=&quot;oid&quot; value=&quot;${o.id}&quot;&gt;
                &lt;input type=&quot;hidden&quot; name=&quot;pid&quot; value=&quot;${p.id}&quot;&gt;
                &lt;button type=&quot;submit&quot;&gt;提交评价&lt;/button&gt;
            &lt;/div&gt;
        &lt;/form&gt;
        &lt;/div&gt;   
    &lt;/c:if&gt;
 
&lt;/div&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
    public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        request.setAttribute(&quot;o&quot;, o);
        return &quot;confirmPay.jsp&quot;;       
    }
     
    public String orderConfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.waitReview);
        o.setConfirmDate(new Date());
        orderDAO.update(o);
        return &quot;orderConfirmed.jsp&quot;;
    }  
     
    public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.delete);
        orderDAO.update(o);
        return &quot;%success&quot;;     
    }
    public String review(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        Product p = o.getOrderItems().get(0).getProduct();
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
        productDAO.setSaleAndReviewNumber(p);
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;o&quot;, o);
        request.setAttribute(&quot;reviews&quot;, reviews);
        return &quot;review.jsp&quot;;       
    }
    public String doreview(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.finish);
        orderDAO.update(o);
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        String content = request.getParameter(&quot;content&quot;);
         
        content = HtmlUtils.htmlEscape(content);
 
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        Review review = new Review();
        review.setContent(content);
        review.setProduct(p);
        review.setCreateDate(new Date());
        review.setUser(user);
        reviewDAO.add(review);
         
        return &quot;@forereview?oid=&quot;+oid+&quot;&amp;showonly=true&quot;;    
    }
     
}
</code></pre>
<h3 id="步骤-5-提交评价"><a class="header-anchor" href="#步骤-5-提交评价">¶</a>步骤 5 : 提交评价</h3>
<p>在[评价产品页面]点击提交评价，就把数据提交到了/foredoreview路径，导致ForeServlet.doreview方法被调用</p>
<ol>
<li>ForeServlet.doreview()<br>
1.1 获取参数oid<br>
1.2 根据oid获取订单对象o<br>
1.3 修改订单对象状态<br>
1.4 更新订单对象到数据库<br>
1.5 获取参数pid<br>
1.6 根据pid获取产品对象<br>
1.7 获取参数content (评价信息)<br>
1.8 对评价信息进行转义，道理同注册[ForeServlet.register()]<br>
1.9 从session中获取当前用户<br>
1.10 创建评价对象review<br>
1.11 为评价对象review设置 评价信息，产品，时间，用户<br>
1.12 增加到数据库<br>
1.13.客户端跳转到/forereview： [评价产品页面]，并带上参数showonly=true</li>
<li>reviewPage.jsp<br>
在reviewPage.jsp中，当参数showonly==true，那么就显示当前产品的所有评价信息</li>
</ol>
<p><img src="3991.png" alt=""></p>
<pre><code class="language-java">public String doreview(HttpServletRequest request, HttpServletResponse response, Page page) {
    int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
    Order o = orderDAO.get(oid);
    o.setStatus(OrderDAO.finish);
    orderDAO.update(o);
    int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
    Product p = productDAO.get(pid);
     
    String content = request.getParameter(&quot;content&quot;);
     
    content = HtmlUtils.htmlEscape(content);
 
    User user =(User) request.getSession().getAttribute(&quot;user&quot;);
    Review review = new Review();
    review.setContent(content);
    review.setProduct(p);
    review.setCreateDate(new Date());
    review.setUser(user);
    reviewDAO.add(review);
     
    return &quot;@forereview?oid=&quot;+oid+&quot;&amp;showonly=true&quot;;    
}
</code></pre>
<pre><code class="language-java">&lt;c:if test=&quot;${param.showonly==true}&quot;&gt;
&lt;div class=&quot;reviewDivlistReviews&quot;&gt;
    &lt;c:forEach items=&quot;${reviews}&quot; var=&quot;r&quot;&gt;
        &lt;div class=&quot;reviewDivlistReviewsEach&quot;&gt;
            &lt;div class=&quot;reviewDate&quot;&gt;&lt;fmt:formatDate value=&quot;${r.createDate}&quot; pattern=&quot;yyyy-MM-dd&quot;/&gt;&lt;/div&gt;
            &lt;div class=&quot;reviewContent&quot;&gt;${r.content}&lt;/div&gt;
            &lt;div class=&quot;reviewUserInfo pull-right&quot;&gt;${r.user.anonymousName}&lt;span class=&quot;reviewUserInfoAnonymous&quot;&gt;(匿名)&lt;/span&gt;&lt;/div&gt;
        &lt;/div&gt;
    &lt;/c:forEach&gt;
&lt;/div&gt;
&lt;/c:if&gt;
</code></pre>
<pre><code class="language-java">package tmall.servlet;
 
import java.io.BufferedWriter;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
 
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
 
import org.apache.commons.lang.math.RandomUtils;
import org.springframework.web.util.HtmlUtils;
 
import tmall.bean.Category;
import tmall.bean.Order;
import tmall.bean.OrderItem;
import tmall.bean.Product;
import tmall.bean.ProductImage;
import tmall.bean.PropertyValue;
import tmall.bean.Review;
import tmall.bean.User;
import tmall.comparator.ProductAllComparator;
import tmall.comparator.ProductDateComparator;
import tmall.comparator.ProductPriceComparator;
import tmall.comparator.ProductReviewComparator;
import tmall.comparator.ProductSaleCountComparator;
import tmall.dao.CategoryDAO;
import tmall.dao.OrderDAO;
import tmall.dao.ProductDAO;
import tmall.dao.ProductImageDAO;
import tmall.util.Page;
 
public class ForeServlet extends BaseForeServlet {
    public String home(HttpServletRequest request, HttpServletResponse response, Page page) {
        List&lt;Category&gt; cs= new CategoryDAO().list();
        new ProductDAO().fill(cs);
        new ProductDAO().fillByRow(cs);
        request.setAttribute(&quot;cs&quot;, cs);
        return &quot;home.jsp&quot;;
    }
 
    public String register(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);
        name = HtmlUtils.htmlEscape(name);
        System.out.println(name);
        boolean exist = userDAO.isExist(name);
         
        if(exist){
            request.setAttribute(&quot;msg&quot;, &quot;用户名已经被使用,不能使用&quot;);
            return &quot;register.jsp&quot;; 
        }
         
        User user = new User();
        user.setName(name);
        user.setPassword(password);
        System.out.println(user.getName());
        System.out.println(user.getPassword());
        userDAO.add(user);
         
        return &quot;@registerSuccess.jsp&quot;; 
    }  
    public String login(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        name = HtmlUtils.htmlEscape(name);
        String password = request.getParameter(&quot;password&quot;);    
         
        User user = userDAO.get(name,password);
          
        if(null==user){
            request.setAttribute(&quot;msg&quot;, &quot;账号密码错误&quot;);
            return &quot;login.jsp&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;@forehome&quot;;
    }  
     
    public String product(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        List&lt;ProductImage&gt; productSingleImages = productImageDAO.list(p, ProductImageDAO.type_single);
        List&lt;ProductImage&gt; productDetailImages = productImageDAO.list(p, ProductImageDAO.type_detail);
        p.setProductSingleImages(productSingleImages);
        p.setProductDetailImages(productDetailImages);
         
        List&lt;PropertyValue&gt; pvs = propertyValueDAO.list(p.getId());      
     
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
         
        productDAO.setSaleAndReviewNumber(p);
 
        request.setAttribute(&quot;reviews&quot;, reviews);
 
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;pvs&quot;, pvs);
        return &quot;product.jsp&quot;;      
    }
    public String logout(HttpServletRequest request, HttpServletResponse response, Page page) {
        request.getSession().removeAttribute(&quot;user&quot;);
        return &quot;@forehome&quot;;
    }
 
    public String checkLogin(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null!=user)
            return &quot;%success&quot;;
        return &quot;%fail&quot;;
    }
    public String loginAjax(HttpServletRequest request, HttpServletResponse response, Page page) {
        String name = request.getParameter(&quot;name&quot;);
        String password = request.getParameter(&quot;password&quot;);    
        User user = userDAO.get(name,password);
         
        if(null==user){
            return &quot;%fail&quot;;
        }
        request.getSession().setAttribute(&quot;user&quot;, user);
        return &quot;%success&quot;; 
    }
    public String category(HttpServletRequest request, HttpServletResponse response, Page page) {
        int cid = Integer.parseInt(request.getParameter(&quot;cid&quot;));
         
        Category c = new CategoryDAO().get(cid);
        new ProductDAO().fill(c);
        new ProductDAO().setSaleAndReviewNumber(c.getProducts());      
         
        String sort = request.getParameter(&quot;sort&quot;);
        if(null!=sort){
        switch(sort){
            case &quot;review&quot;:
                Collections.sort(c.getProducts(),new ProductReviewComparator());
                break;
            case &quot;date&quot; :
                Collections.sort(c.getProducts(),new ProductDateComparator());
                break;
                 
            case &quot;saleCount&quot; :
                Collections.sort(c.getProducts(),new ProductSaleCountComparator());
                break;
                 
            case &quot;price&quot;:
                Collections.sort(c.getProducts(),new ProductPriceComparator());
                break;
                 
            case &quot;all&quot;:
                Collections.sort(c.getProducts(),new ProductAllComparator());
                break;
            }
        }
         
        request.setAttribute(&quot;c&quot;, c);
        return &quot;category.jsp&quot;;     
    }
     
    public String search(HttpServletRequest request, HttpServletResponse response, Page page){
        String keyword = request.getParameter(&quot;keyword&quot;);
        List&lt;Product&gt; ps= new ProductDAO().search(keyword,0,20);
        productDAO.setSaleAndReviewNumber(ps);
        request.setAttribute(&quot;ps&quot;,ps);
        return &quot;searchResult.jsp&quot;;
    }
 
    public String buyone(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
        Product p = productDAO.get(pid);
        int oiid = 0;
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                oiid = oi.getId();
                break;
            }
        }      
 
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
            oiid = oi.getId();
        }
        return &quot;@forebuy?oiid=&quot;+oiid;
    }
 
    public String buy(HttpServletRequest request, HttpServletResponse response, Page page){
        String[] oiids=request.getParameterValues(&quot;oiid&quot;);
        List&lt;OrderItem&gt; ois = new ArrayList&lt;&gt;();
        float total = 0;
 
        for (String strid : oiids) {
            int oiid = Integer.parseInt(strid);
            OrderItem oi= orderItemDAO.get(oiid);
            total +=oi.getProduct().getPromotePrice()*oi.getNumber();
            ois.add(oi);
        }
         
        request.getSession().setAttribute(&quot;ois&quot;, ois);
        request.setAttribute(&quot;total&quot;, total);
        return &quot;buy.jsp&quot;;
    }  
    public String addCart(HttpServletRequest request, HttpServletResponse response, Page page) {
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
        int num = Integer.parseInt(request.getParameter(&quot;num&quot;));
         
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        boolean found = false;
 
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==p.getId()){
                oi.setNumber(oi.getNumber()+num);
                orderItemDAO.update(oi);
                found = true;
                break;
            }
        }      
         
        if(!found){
            OrderItem oi = new OrderItem();
            oi.setUser(user);
            oi.setNumber(num);
            oi.setProduct(p);
            orderItemDAO.add(oi);
        }
        return &quot;%success&quot;;
    }
    public String cart(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        request.setAttribute(&quot;ois&quot;, ois);
        return &quot;cart.jsp&quot;;
    }
 
    public String changeOrderItem(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
 
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        int number = Integer.parseInt(request.getParameter(&quot;number&quot;));
        List&lt;OrderItem&gt; ois = orderItemDAO.listByUser(user.getId());
        for (OrderItem oi : ois) {
            if(oi.getProduct().getId()==pid){
                oi.setNumber(number);
                orderItemDAO.update(oi);
                break;
            }
             
        }      
        return &quot;%success&quot;;
    }
 
    public String deleteOrderItem(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        if(null==user)
            return &quot;%fail&quot;;
        int oiid = Integer.parseInt(request.getParameter(&quot;oiid&quot;));
        orderItemDAO.delete(oiid);
        return &quot;%success&quot;;
    }
 
    public String createOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
 
        String address = request.getParameter(&quot;address&quot;);
        String post = request.getParameter(&quot;post&quot;);
        String receiver = request.getParameter(&quot;receiver&quot;);
        String mobile = request.getParameter(&quot;mobile&quot;);
        String userMessage = request.getParameter(&quot;userMessage&quot;);
         
        String orderCode = new SimpleDateFormat(&quot;yyyyMMddHHmmssSSS&quot;).format(new Date()) +RandomUtils.nextInt(10000);
        Order order = new Order();
        order.setOrderCode(orderCode);
        order.setAddress(address);
        order.setPost(post);
        order.setReceiver(receiver);
        order.setMobile(mobile);
        order.setUserMessage(userMessage);
        order.setCreateDate(new Date());
        order.setUser(user);
        order.setStatus(OrderDAO.waitPay);
 
        orderDAO.add(order);
 
        List&lt;OrderItem&gt; ois= (List&lt;OrderItem&gt;) request.getSession().getAttribute(&quot;ois&quot;);       
        float total =0;
        for (OrderItem oi: ois) {
            oi.setOrder(order);
            orderItemDAO.update(oi);
            total+=oi.getProduct().getPromotePrice()*oi.getNumber();
        }
         
        return &quot;@forealipay?oid=&quot;+order.getId() +&quot;&amp;total=&quot;+total;
    }
     
    public String alipay(HttpServletRequest request, HttpServletResponse response, Page page){
        return &quot;alipay.jsp&quot;;
    }
 
    public String payed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order order = orderDAO.get(oid);
        order.setStatus(OrderDAO.waitDelivery);
        order.setPayDate(new Date());
        new OrderDAO().update(order);
        request.setAttribute(&quot;o&quot;, order);
        return &quot;payed.jsp&quot;;    
    }  
 
    public String bought(HttpServletRequest request, HttpServletResponse response, Page page) {
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        List&lt;Order&gt; os= orderDAO.list(user.getId(),OrderDAO.delete);
         
        orderItemDAO.fill(os);
         
        request.setAttribute(&quot;os&quot;, os);
         
        return &quot;bought.jsp&quot;;       
    }
    public String confirmPay(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        request.setAttribute(&quot;o&quot;, o);
        return &quot;confirmPay.jsp&quot;;       
    }
     
    public String orderConfirmed(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.waitReview);
        o.setConfirmDate(new Date());
        orderDAO.update(o);
        return &quot;orderConfirmed.jsp&quot;;
    }  
     
    public String deleteOrder(HttpServletRequest request, HttpServletResponse response, Page page){
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.delete);
        orderDAO.update(o);
        return &quot;%success&quot;;     
    }
    public String review(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        orderItemDAO.fill(o);
        Product p = o.getOrderItems().get(0).getProduct();
        List&lt;Review&gt; reviews = reviewDAO.list(p.getId());
        productDAO.setSaleAndReviewNumber(p);
        request.setAttribute(&quot;p&quot;, p);
        request.setAttribute(&quot;o&quot;, o);
        request.setAttribute(&quot;reviews&quot;, reviews);
        return &quot;review.jsp&quot;;       
    }
    public String doreview(HttpServletRequest request, HttpServletResponse response, Page page) {
        int oid = Integer.parseInt(request.getParameter(&quot;oid&quot;));
        Order o = orderDAO.get(oid);
        o.setStatus(OrderDAO.finish);
        orderDAO.update(o);
        int pid = Integer.parseInt(request.getParameter(&quot;pid&quot;));
        Product p = productDAO.get(pid);
         
        String content = request.getParameter(&quot;content&quot;);
         
        content = HtmlUtils.htmlEscape(content);
 
        User user =(User) request.getSession().getAttribute(&quot;user&quot;);
        Review review = new Review();
        review.setContent(content);
        review.setProduct(p);
        review.setCreateDate(new Date());
        review.setUser(user);
        reviewDAO.add(review);
         
        return &quot;@forereview?oid=&quot;+oid+&quot;&amp;showonly=true&quot;;    
    }
     
}
</code></pre>
<h1 id="十六、总结"><a class="header-anchor" href="#十六、总结">¶</a>十六、总结</h1>
<h2 id="1、项目总结"><a class="header-anchor" href="#1、项目总结">¶</a>1、项目总结</h2>
<p>到这里，项目功能开发就做得差不多了，接下来我们将进行对项目的总结，为的是更好的消化和吸收项目期间运用到的知识和技能，转换为自己的能力。</p>
<h3 id="步骤-1-项目结构"><a class="header-anchor" href="#步骤-1-项目结构">¶</a>步骤 1 : 项目结构</h3>
<ol>
<li>项目名称 tmall</li>
<li>java源代码包结构<br>
tmall.bean 实体类<br>
tmall.comparator 比较器<br>
tmall.dao DAO类<br>
tmall.filter 过滤器<br>
tmall.servlet servlet<br>
tmall.test 测试类<br>
tmall.util 工具类</li>
<li>web目录<br>
css css文件<br>
img 图片资源<br>
js js文件<br>
admin 后台管理用到的jsp文件<br>
include 被包含的jsp文件</li>
</ol>
<p><img src="3995.png" alt=""></p>
<h3 id="步骤-2-典型场景"><a class="header-anchor" href="#步骤-2-典型场景">¶</a>步骤 2 : 典型场景</h3>
<p>经过这个项目，我们都完成了如下的一系列典型场景功能</p>
<ol>
<li>
<p>购物车<br>
[立即购买] [加入购物车] [查看购物车页面] [购物车页面操作]</p>
</li>
<li>
<p>订单状态流转<br>
[生成订单] [确认支付] [后台发货] [确认收货] [评价]</p>
</li>
<li>
<p>CRUD<br>
[后台各种功能]</p>
</li>
<li>
<p>分页<br>
[后台各种功能]</p>
</li>
<li>
<p>一类产品多属性配置<br>
[属性管理]</p>
</li>
<li>
<p>一款产品多图片维护<br>
[产品图片管理]</p>
</li>
<li>
<p>产品展示<br>
[前台首页] [前台产品页]</p>
</li>
<li>
<p>搜索查询<br>
[搜索]</p>
</li>
<li>
<p>登录、注册<br>
[注册] [登录] [退出]</p>
</li>
<li>
<p>登录验证<br>
[登录状态Filter]</p>
</li>
</ol>
<p>等等 。。。</p>
<h3 id="步骤-3-设计模式"><a class="header-anchor" href="#步骤-3-设计模式">¶</a>步骤 3 : 设计模式</h3>
<ol>
<li>
<p>MVC<br>
[MVC设计模式]贯穿于整个后台与前台功能开发始末</p>
</li>
<li>
<p>Filter+Servlet+反射<br>
采用[Filter+Servlet+反射]的设计模式，<br>
把原本后台需要20多个Servlet的经典Servlet设计方式，精简到了7个。<br>
把原本前台需要20多个Servlet的经典Servlet设计方式，精简到了2个。<br>
web.xml的配置文件也大大减少，降低了开发和维护的工作量，减少了出错的几率。</p>
</li>
<li>
<p>统一的分页查询简化开发<br>
所有的后台都使用同一个[分页]机制，仅仅需要一份[简化的adminPage.jsp]即满足了各种分页功能的需求，简化了开发，提升了开发速度。</p>
</li>
<li>
<p>模块化JSP设计<br>
从大的JSP文件中，通过[JSP包含关系]抽象出多个公共文件，并把业务JSP按照功能，设计为多个小的JSP文件，便于维护和理解</p>
</li>
</ol>
<h2 id="2、改进练习"><a class="header-anchor" href="#2、改进练习">¶</a>2、改进练习</h2>
<p>还有些功能可以继续完善。</p>
<ol>
<li>后台管理员登陆模块</li>
<li>产品图片排序</li>
<li>前台分类下显示产品，提供分页功能<br>
等等</li>
</ol>
<p>学习是为了提高能力，去完成复杂和更有挑战的任务，这些功能就交由同学们自己完成了</p>
<h1 id="十七、下载"><a class="header-anchor" href="#十七、下载">¶</a>十七、下载</h1>
<h2 id="1、完整项目下载"><a class="header-anchor" href="#1、完整项目下载">¶</a>1、完整项目下载</h2>
<p><strong>注</strong> 源代码仅仅是为了演示效果，并非为了学习使用。 因为页面很多，涉及太多类，方法，类之间的关系，复杂的调用关系，页面包含关系，不应该直接基于如此复杂的源代码进行，只会导致学习效率低下，应该<strong>按照教程节奏</strong>，一步一步由浅入深地进行，方能事半功倍。</p>
<h3 id="步骤-1-JDK1-8"><a class="header-anchor" href="#步骤-1-JDK1-8">¶</a>步骤 1 : JDK1.8</h3>
<p>因为天猫J2EE版本使用了挺多的JDK1.8的新特性，为了正常运行，请务必确认当前java环境是JDK1.8.<br>
在命令行中输入<strong>java -version</strong>进行校验</p>
<p>参考JDK下载以及配置办法： [JDK1.8以及更高版本下载和环境变量配置]</p>
<p>JDK9 不够稳定，特别是Tomcat7 <strong>无法在JDK9 中运行</strong>，请勿使用JDK9运行本项目，请切换至JDK8，谢谢</p>
<p><img src="4074.png" alt=""></p>
<h3 id="步骤-2-导入SQL语句-tmall-sql"><a class="header-anchor" href="#步骤-2-导入SQL语句-tmall-sql">¶</a>步骤 2 : 导入SQL语句 tmall.sql</h3>
<p>tmall.rar只包含了项目必须的代码，但是没有数据，为了看到运行效果，还必须导入数据。</p>
<p>在右侧下载 sql 文件，然后使用如下的 命令行方式导入。如果没有安装mysql,可以参考[安装mysql-server]<br>
<strong>注：</strong> 不要用 navicat,mysql-front 等工具导入，因为数据量大，这些工具处理不了，会报奇奇怪怪的错误。</p>
<p><strong>本tmall.sql 包含17个分类，每种分类下5个产品，总计85件产品。 每个产品下有20余张图片，总计1777张图片，以及属性和属性值等信息。</strong><br>
<strong>注:</strong> 在导入数据之前，需要mysql服务器上存在tmall这个数据库，如果没有请执行以下sql语句：<br>
先登录</p>
<pre><code class="language-cmd">&quot;D:\tools\MYSQL\mysql-5.1.57-win32\bin\mysql.exe&quot; -u root -padmin
</code></pre>
<p>然后执行创建数据库的SQL语句</p>
<pre><code class="language-mysql">CREATE DATABASE tmall DEFAULT CHARACTER SET utf8;
</code></pre>
<p>然后在当前 mysql 环境下输入 <strong>exit 退出 mysql 环境</strong>，才能进行下面的在cmd环境下的导入<br>
考虑到要导入的tmall.sql文件比较大，通过工具如mysql-front导入的时候，可能会出错导致失败，建议使用命令行导入：</p>
<pre><code class="language-cmd">&quot;D:\tools\MYSQL\mysql-5.1.57-win32\bin\mysql.exe&quot; -u root -padmin --default-character-set=utf8 tmall &lt; d:\tmall.sql
</code></pre>
<p><strong>注:</strong> 账号密码是root，admin，导入数据以及项目运行所使用的账号密码都是这个，如果不是，请将mysql的root账号密码修改为admin,参考 [修改root密码]<br>
<strong>注:</strong> D:\tools\MYSQL\mysql-5.1.57-win32\bin\mysql.exe 这个路径是我的mysql.exe的路径，根据实际情况换成自己的mysql运行路径<br>
<strong>注:</strong> tmall.sql下载后，放在 d:\tmall.sql 这个位置<br>
<strong>注:</strong> tmall.sql 总计有14700行，所以导入是比较耗时的，预计3-5分钟左右, 视机器配置而定<br>
**注：**导入过程中，有可能提示的 Unknown table engine ‘InnoDB’， 这是因为当前数据库未支持InnoDB。 解决办法请参考[启动MySQL InnoDB模式]</p>
<h3 id="步骤-3-关于IDE"><a class="header-anchor" href="#步骤-3-关于IDE">¶</a>步骤 3 : 关于IDE</h3>
<p>本教程使用Eclispe EE版本开发，推荐使用一样的eclispe版本：[下载 Eclipse]。<br>
如果使用MyEclipse 请检查其内置Java Compiler是否支持JDK 1.8，否则无法使用。<br>
如果使用IDEAR 请检查其内置Java Compiler是否支持JDK 1.8，否则无法使用。</p>
<h3 id="步骤-4-完整项目下载"><a class="header-anchor" href="#步骤-4-完整项目下载">¶</a>步骤 4 : 完整项目下载</h3>
<ol>
<li>下载右上角的tmall.rar</li>
<li>解压到e:/project/tmall</li>
</ol>
<p><strong>注</strong>： 这个项目里包含了所有的源代码</p>
<h3 id="步骤-5-配置tomcat"><a class="header-anchor" href="#步骤-5-配置tomcat">¶</a>步骤 5 : 配置tomcat</h3>
<p>最简单的办法，下载右上角配置好的tomcat_for_tmall.rar,解压后运行 bin目录下的<strong>startup.bat</strong>即可。 (前提是8080端口未被占用，如果已经被占用，请使用排查手段：[tomcat端口被占用怎么办])</p>
<p>以下是手动配置已经存在的tomcat办法：<br>
打开tomcat/conf/server.xml，在&lt;Host下增加一个&lt;context</p>
<pre><code class="language-xml">&lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
	&lt;Context path=&quot;/tmall&quot; docBase=&quot;E:\\project\\tmall\\web&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; /&gt;
</code></pre>
<p>通过这种方式部署tmall web应用，注意reloadable=“false” 要设置为false，不要自动重载，这个功能tomcat本身做的不够完善，会带来意想不到的问题。</p>
<p>为什么不用Eclipse EE版本,或者MyEclipse的自带的tomcat 启动？<br>
因为大家工作以后，最常见的工作环境是： 在Windows下开发，然后把开发好的web项目部署到Linux的服务器上。 是不可能在Linux启动一个eclipse/myeclipse，然后里面跑一个tomcat来运行的！<br>
所以尽可能采用接近生产环境的方式部署web应用，也是为了让以后能够工作的更加平滑。</p>
<p>如果这一步老是配置不成功，可以使用下面的server.xml完整文件代码，或者右边下载server.xml来替换。</p>
<p><strong>注：</strong> 这个完整的server.xml里用的端口号是<strong>8080</strong></p>
<pre><code class="language-xml">&lt;?xml version='1.0' encoding='utf-8'?&gt;
&lt;Server port=&quot;8085&quot; shutdown=&quot;SHUTDOWN&quot;&gt;
  &lt;Listener className=&quot;org.apache.catalina.startup.VersionLoggerListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine=&quot;on&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.JasperListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; /&gt;
  &lt;Listener className=&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; /&gt;
  &lt;GlobalNamingResources&gt;
    &lt;Resource name=&quot;UserDatabase&quot; auth=&quot;Container&quot;
              type=&quot;org.apache.catalina.UserDatabase&quot;
              description=&quot;User database that can be updated and saved&quot;
              factory=&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;
              pathname=&quot;conf/tomcat-users.xml&quot; /&gt;
  &lt;/GlobalNamingResources&gt;
  &lt;Service name=&quot;Catalina&quot;&gt;
    &lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;
               connectionTimeout=&quot;20000&quot;
               redirectPort=&quot;8443&quot; /&gt;
    &lt;Connector port=&quot;8089&quot; protocol=&quot;AJP/1.3&quot; redirectPort=&quot;8443&quot; /&gt;
    &lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;
      &lt;Realm className=&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;
        &lt;Realm className=&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;
               resourceName=&quot;UserDatabase&quot;/&gt;
      &lt;/Realm&gt;
      &lt;Host name=&quot;localhost&quot;  appBase=&quot;webapps&quot;
            unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;
					&lt;Context path=&quot;/tmall&quot; docBase=&quot;E:\\project\\tmall\\web&quot; debug=&quot;0&quot; reloadable=&quot;false&quot; /&gt;
		
       &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;
               prefix=&quot;localhost_access_log.&quot; suffix=&quot;.txt&quot;
               pattern=&quot;%h %l %u %t &amp;quot;%r&amp;quot; %s %b&quot; /&gt;
      &lt;/Host&gt;
    &lt;/Engine&gt;
  &lt;/Service&gt;
&lt;/Server&gt;
</code></pre>
<p><img src="4071.png" alt=""></p>
<h3 id="步骤-6-访问"><a class="header-anchor" href="#步骤-6-访问">¶</a>步骤 6 : 访问</h3>
<p>重启tomcat</p>
<ol>
<li>访问前台页面</li>
</ol>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/
</code></pre>
<ol start="2">
<li>访问后台页面</li>
</ol>
<pre><code class="language-http">http://127.0.0.1:8080/tmall/admin
</code></pre>
